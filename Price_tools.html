<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400, user-scalable=yes">
    <title>ç«¶åƒ¹å·¥å…·</title>
    <style>
:root {
    --primary: #667eea;
    --primary-dark: #764ba2;
    --success: #4caf50;
    --success-dark: #45a049;
    --danger: #ef5350;
    --danger-dark: #e53935;
    --info: #42a5f5;
    --info-dark: #1e88e5;
    --warning: #ffc107;
    --bg-main: #f8f9fa;
    --bg-hover: #f0f4ff;
    --bg-success: #f1f8e9;
    --bg-warning: #fff9e6;
    --border: #e0e0e0;
    --border-light: #e9ecef;
    --text-primary: #333;
    --text-secondary: #666;
    --text-muted: #999;
    --text-hint: #bbb;
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 20px;
    --spacing-xs: 8px;
    --spacing-sm: 15px;
    --spacing-md: 20px;
    --spacing-lg: 30px;
    --transition: all 0.3s ease;
    --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    --gradient-success: linear-gradient(135deg, #e8f5e9 0%, var(--bg-success) 100%);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
    background: var(--gradient-primary);
    min-height: 100vh;
    padding: var(--spacing-md);
    color: var(--text-primary);
}

.container {
    min-width: 1200px;
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

header {
    background: var(--gradient-primary);
    color: white;
    padding: 40px var(--spacing-lg);
    text-align: center;
}

header h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
    font-weight: 700;
}

.main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
    padding: var(--spacing-lg);
}

.form-section, .results-section {
    background: var(--bg-main);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
}

.form-section h2, .results-section h2 {
    color: var(--text-primary);
    font-size: 1.8em;
    margin-bottom: 25px;
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--border);
}

.price-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-sm);
}

label {
    font-weight: 600;
    color: #555;
    font-size: 0.95em;
}

label input[type="checkbox"] {
    margin-right: var(--spacing-xs);
    width: auto;
    cursor: pointer;
}

input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--primary);
}

input[type="text"],
input[type="number"],
input[type="url"],
select {
    padding: 12px var(--spacing-sm);
    font-size: 1em;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    outline: none;
    transition: var(--transition);
    font-family: inherit;
    width: 100%;
}

textarea {
    padding: 12px var(--spacing-sm);
    font-size: 1em;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    outline: none;
    transition: var(--transition);
    font-family: inherit;
    width: 100%;
    resize: vertical;
    min-height: 80px;
}

input:focus,
select:focus,
textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield;
    appearance: textfield;
}

select {
    cursor: pointer;
    background: white;
}

.form-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: 10px;
}

.btn {
    padding: 14px var(--spacing-lg);
    font-size: 1em;
    font-weight: 600;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    flex: 1;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: var(--border);
    color: var(--text-primary);
}

.btn-secondary:hover {
    background: #d0d0d0;
}

.btn-danger, .btn-delete {
    background: var(--danger);
    color: white;
}
.btn-danger:hover, .btn-delete:hover { background: var(--danger-dark); }
.btn-danger { padding: 10px var(--spacing-md); font-size: 0.9em; }
.btn-delete { padding: var(--spacing-xs) 16px; font-size: 0.85em; }

.btn-edit {
    background: var(--info);
    color: white;
    padding: var(--spacing-xs) 16px;
    font-size: 0.85em;
}
.btn-edit:hover { background: var(--info-dark); }

/* åœ“å½¢æŒ‰éˆ•é€šç”¨æ¨£å¼ */
.btn-circle {
    padding: 6px;
    font-size: 16px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

.btn-remove-product {
    background: var(--danger);
    color: white;
    box-shadow: 0 2px 4px rgba(244, 67, 54, 0.2);
}

.btn-remove-product:hover {
    background: var(--danger-dark);
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(244, 67, 54, 0.4);
}


.btn-small {
    padding: 6px 12px;
    font-size: 0.85em;
    flex: 1;
}

.results-header {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin-bottom: 25px;
    padding-bottom: var(--spacing-sm);
}

.results-header h2 {
    margin: 0;
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--border);
    width: 100%;
}

.search-container {
    width: 100%;
    margin-top: var(--spacing-xs);
}

.search-input {
    padding: 10px var(--spacing-sm);
    font-size: 0.95em;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    outline: none;
    transition: var(--transition);
    font-family: inherit;
    width: 100%;
    background: white;
}

.search-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-input::placeholder {
    color: var(--text-muted);
}

.empty-state {
    text-align: center;
    padding: 60px var(--spacing-md);
    color: var(--text-muted);
}

.empty-state p {
    font-size: 1.2em;
    margin-bottom: 10px;
}

.hint {
    font-size: 0.95em;
    color: var(--text-hint);
}

.comparison-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.product-group, .store-group {
    background: white;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    transition: var(--transition);
}

.product-group:hover {
    border-color: var(--primary);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15);
}

.store-group {
    position: relative;
}

.store-group:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
}

.product-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
    gap: var(--spacing-sm);
}

.product-group-name {
    font-size: 1.3em;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    flex: 1;
    cursor: default;
}

.product-group-name.has-image,
.product-group-name.no-image {
    cursor: pointer;
    transition: var(--transition);
}

.product-group-name.has-image:hover,
.product-group-name.no-image:hover {
    color: var(--primary);
    text-decoration: underline;
}

.btn-add-store-to-product {
    background: var(--success);
    color: white;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
}

.btn-add-store-to-product:hover {
    background: var(--success-dark);
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

.image-view-modal-content {
    max-width: 90vw;
    max-height: 90vh;
    padding: var(--spacing-md);
}

.image-view-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    min-height: 200px;
    background: var(--bg-main);
    border-radius: var(--radius-sm);
    padding: var(--spacing-md);
}

.image-view-image {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: opacity 0.3s ease;
}

.image-view-image:hover {
    opacity: 0.8;
}

.image-view-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 1.1em;
    padding: var(--spacing-md);
    text-align: center;
    cursor: pointer;
    min-height: 200px;
}

.image-view-actions {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-md);
    align-items: center;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--border);
}

.modal-title {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2em;
    color: var(--text-muted);
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.modal-close:hover {
    background: var(--bg-main);
    color: var(--text-primary);
}

.product-stores-list {
    display: none;
    flex-direction: column;
    gap: var(--spacing-xs);
    transition: opacity 0.3s ease, max-height 0.3s ease;
}

.product-group:hover .product-stores-list {
    display: flex;
}

.store-item {
    background: var(--bg-main);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
}

.store-item:hover {
    border-color: var(--primary);
    background: var(--bg-hover);
}

.store-item.best-price {
    border-color: var(--success);
    border-width: 2px;
    background: var(--bg-success);
}

.store-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px var(--spacing-sm);
    cursor: pointer;
    gap: var(--spacing-sm);
}

.store-item-name {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
}

.store-item-price {
    font-size: 1.1em;
    font-weight: 700;
    color: var(--primary);
    min-width: 80px;
    text-align: right;
}

.store-item-arrow {
    color: var(--text-muted);
    font-size: 0.9em;
    transition: transform 0.3s ease;
    min-width: 20px;
}

.store-item-arrow.expanded {
    transform: rotate(90deg);
}

.store-item-details {
    display: none;
    padding: var(--spacing-sm);
    background: white;
    border-top: 1px solid var(--border);
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
}

.store-item-details.expanded {
    display: block;
}

.store-item-actions {
    display: flex;
    gap: 10px;
    margin-top: var(--spacing-sm);
    padding-top: var(--spacing-sm);
    border-top: 1px solid var(--border-light);
}


.store-platform-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 600;
    color: white;
    min-width: 60px;
    height: 24px;
    text-align: center;
    margin-right: 5px;
    box-sizing: border-box;
    line-height: 1;
}
.store-platform-icon.platform-1688 { background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%); }
.store-platform-icon.platform-taobao { background: linear-gradient(135deg, #ff5000 0%, #ff6b35 100%); }
.store-platform-icon.platform-tmall { background: linear-gradient(135deg, #ff0036 0%, #ff3366 100%); }

.item-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-light);
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-label {
    font-size: 0.95em;
    color: var(--text-secondary);
    font-weight: 500;
}

.detail-value {
    font-size: 1.05em;
    color: var(--text-primary);
    font-weight: 600;
}
.detail-value .text-success { color: var(--success); }
.detail-value .text-primary { color: var(--primary); font-weight: 700; }

.best-unit-price-badge {
    display: inline-block;
    background: var(--success);
    color: white;
    padding: 5px var(--spacing-sm);
    border-radius: var(--radius-lg);
    font-size: 0.85em;
    font-weight: 600;
    margin-left: 10px;
}

.best-total-price-badge {
    display: inline-block;
    background: var(--info);
    color: white;
    padding: 5px var(--spacing-sm);
    border-radius: var(--radius-lg);
    font-size: 0.85em;
    font-weight: 600;
    margin-left: 10px;
}

.stores-container {
    display: none;
}

.stores-container.active {
    display: block;
}

.validation-message {
    color: var(--danger);
    font-size: 0.85em;
    margin-top: 5px;
    display: none;
}

.validation-message.show {
    display: block;
}

.price-calculation-box {
    background: var(--bg-hover);
    padding: var(--spacing-xs);
    border-radius: 6px;
    margin-top: 10px;
}

.price-calculation-row {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.price-calculation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.price-calculation-label { color: var(--text-secondary); }
.price-calculation-value { font-weight: 700; color: var(--primary); }

/* æŒ‰éˆ•çµ„æ¨£å¼ */
.btn-group {
    display: flex;
    gap: var(--spacing-xs);
}

.btn-flex {
    flex: 1;
}

.hidden {
    display: none !important;
}

.image-upload-container {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.image-preview-container {
    position: relative;
    width: 100%;
    min-height: 200px;
    border: 2px dashed var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-main);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    overflow: hidden;
}

.image-preview-container:hover {
    border-color: var(--primary);
    background: var(--bg-hover);
}

.image-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 1.1em;
    padding: var(--spacing-md);
    text-align: center;
}

.image-preview {
    max-width: 100%;
    max-height: 300px;
    object-fit: contain;
    border-radius: var(--radius-sm);
    cursor: pointer;
}

.image-preview:hover {
    opacity: 0.8;
}

.image-remove-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    transition: var(--transition);
}

.image-remove-btn:hover {
    background: var(--danger-dark);
    transform: scale(1.1);
}

.upload-progress {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-light);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    transition: width 0.3s ease;
    width: 0%;
}

.upload-progress span {
    font-size: 0.9em;
    color: var(--text-secondary);
}

/* å•†å“åœ–ç‰‡é¡¯ç¤ºæ¨£å¼ */
.product-image {
    max-width: 100px;
    max-height: 100px;
    object-fit: contain;
    border-radius: var(--radius-sm);
    border: 2px solid var(--border);
    margin-right: var(--spacing-sm);
}

/* æ‡¸åœç¸®åœ–æ¨£å¼ */
.product-name-wrapper {
    position: relative;
    flex: 1;
    display: flex;
    align-items: center;
}

.hover-thumbnail {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 100;
    background: white;
    padding: 6px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    width: 200px;
    margin-top: 10px;
    pointer-events: none;
}

.hover-thumbnail::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 20px;
    width: 10px;
    height: 10px;
    background: white;
    border-top: 1px solid var(--border);
    border-left: 1px solid var(--border);
    transform: rotate(45deg);
}

.hover-thumbnail img {
    width: 100%;
    height: auto;
    border-radius: 4px;
    display: block;
}

.product-name-wrapper:hover .hover-thumbnail {
    display: block;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* å›ºå®šæ¡Œé¢ç‰ˆå‹ï¼šæ‰€æœ‰è£ç½®çš†é¡¯ç¤ºèˆ‡é›»è…¦ç›¸åŒçš„ç‰ˆé¢ï¼Œä¸ä¾è¢å¹•å¯¬åº¦é‡æ’ */
    </style>
    
    <!-- Local config (see .gitignore) -->
    <script src="API KEY/config.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ’° ç«¶åƒ¹å·¥å…·</h1>
        </header>

        <div class="main-content">
            <!-- æ–°å¢è¡¨å–® -->
            <div class="form-section">
                <h2>æ–°å¢</h2>
                <form id="priceForm" class="price-form">
                    <div class="form-group">
                        <label for="productName">å•†å“åç¨±</label>
                        <input 
                            type="text" 
                            id="productName" 
                            required
                        >
                        <span id="productNameValidation" class="validation-message"></span>
                    </div>

                    <div class="form-group">
                        <label for="productImage">å•†å“åœ–ç‰‡</label>
                        <div class="image-upload-container">
                            <input 
                                type="file" 
                                id="productImage" 
                                accept="image/*"
                                style="display: none;"
                            >
                            <div class="image-preview-container">
                                <img id="productImagePreview" src="" alt="é è¦½åœ–ç‰‡" class="image-preview hidden">
                                <button type="button" id="removeImageBtn" class="image-remove-btn hidden" title="ç§»é™¤åœ–ç‰‡">Ã—</button>
                                <div id="productImagePlaceholder" class="image-placeholder">
                                    <span>æ–°å¢åœ–ç‰‡</span>
                                </div>
                            </div>
                            <div id="imageUploadProgress" class="upload-progress hidden">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <span id="progressText">ä¸Šå‚³ä¸­...</span>
                            </div>
                        </div>
                    </div>

                    <div id="storesContainer" class="stores-container">
                        <div id="storesList"></div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-flex">æ–°å¢</button>
                        <button type="button" id="resetBtn" class="btn btn-secondary btn-flex">é‡ç½®</button>
                    </div>
                </form>
            </div>

            <!-- æ¯”åƒ¹çµæœåˆ—è¡¨ -->
            <div class="results-section">
                <div class="results-header">
                    <h2>çµæœ</h2>
                    <div class="search-container">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="search-input"
                        >
                    </div>
                </div>

                <div id="emptyState" class="empty-state">
                    <p>ğŸ“ å°šæœªæ–°å¢ä»»ä½•æ¯”åƒ¹è¨˜éŒ„</p>
                    <p class="hint">è«‹åœ¨ä¸Šæ–¹è¡¨å–®ä¸­æ–°å¢åº—å®¶è³‡è¨Š</p>
                </div>

                <div id="comparisonList" class="comparison-list hidden"></div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯è¨˜éŒ„å½ˆå‡ºè¦–çª— -->
    <div id="editRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="editModalTitle">ç·¨è¼¯æ¯”åƒ¹è¨˜éŒ„</h3>
                <button class="modal-close" onclick="closeEditRecordModal()">&times;</button>
            </div>
            <form id="editRecordModalForm" class="price-form">
                <div class="form-group">
                    <label>å•†å®¶é€£çµ</label>
                    <input 
                        type="url" 
                        id="editStoreUrl"
                        class="store-url-input"
                    >
                    <span id="editUrlValidation" class="url-validation-message validation-message"></span>
                </div>
                <div id="editStoreDetails" class="store-details-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¸½é‡‘é¡</label>
                            <input 
                                type="number" 
                                id="editTotalPrice"
                                class="store-total-input"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        <div class="form-group">
                            <label>æ•¸é‡</label>
                            <input 
                                type="number" 
                                id="editQuantity"
                                class="store-quantity-input"
                                min="1"
                                step="1"
                                value="1"
                            >
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é‹è²»é‡‘é¡</label>
                            <input 
                                type="number" 
                                id="editShipping"
                                class="store-shipping-input"
                                min="0"
                                step="0.01"
                                value=""
                            >
                        </div>
                        <div class="form-group">
                            <label>å„ªæƒ é‡‘é¡</label>
                            <input 
                                type="number" 
                                id="editCoupon"
                                class="store-coupon-input"
                                min="0"
                                step="0.01"
                                value=""
                            >
                        </div>
                    </div>
                    <div class="form-group price-calculation-box">
                        <div class="price-calculation-row">
                            <div class="price-calculation-item">
                                <span class="price-calculation-label">å•†å“å–®åƒ¹ï¼š</span>
                                <span id="editCalculatedPrice" class="price-calculation-value">-</span>
                            </div>
                            <div class="price-calculation-item">
                                <span class="price-calculation-label">å•†å“ç¸½åƒ¹ï¼š</span>
                                <span id="editCalculatedTotal" class="price-calculation-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-flex">æ›´æ–°</button>
                    <button type="button" class="btn btn-secondary btn-flex" onclick="closeEditRecordModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åœ–ç‰‡æŸ¥çœ‹å½ˆå‡ºè¦–çª— -->
    <div id="imageViewModal" class="modal">
        <div class="modal-content image-view-modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="imageViewModalTitle">å•†å“åœ–ç‰‡</h3>
                <button class="modal-close" onclick="closeImageViewModal()">&times;</button>
            </div>
            <div class="image-view-container" id="imageViewContainer">
                <img id="imageViewImage" src="" alt="å•†å“åœ–ç‰‡" class="image-view-image">
                <div id="imageViewPlaceholder" class="image-view-placeholder hidden">
                    <span>æ–°å¢åœ–ç‰‡</span>
                </div>
                <button id="imageViewRemoveBtn" class="image-remove-btn" title="åˆªé™¤åœ–ç‰‡">Ã—</button>
            </div>
            <div class="image-view-actions">
                <input type="file" id="imageViewFileInput" accept="image/*" style="display: none;">
                <div id="imageViewUploadProgress" class="upload-progress hidden">
                    <div class="progress-bar">
                        <div class="progress-fill" id="imageViewProgressFill"></div>
                    </div>
                    <span id="imageViewProgressText">ä¸Šå‚³ä¸­...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤åœ–ç‰‡ç¢ºèªå½ˆå‡ºè¦–çª— -->
    <div id="deleteImageConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ­£åœ¨åˆªé™¤åœ–ç‰‡</h3>
            </div>
            <div class="modal-body" style="padding: var(--spacing-md) 0;">
                <div class="form-actions">
                    <button type="button" class="btn btn-primary btn-flex" id="confirmDeleteImageBtn">æ˜¯çš„</button>
                    <button type="button" class="btn btn-secondary btn-flex" onclick="closeDeleteImageConfirmModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢åº—å®¶å½ˆå‡ºè¦–çª— -->
    <div id="addStoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalProductName">æ–°å¢åº—å®¶</h3>
                <button class="modal-close" onclick="closeAddStoreModal()">&times;</button>
            </div>
            <form id="addStoreModalForm" class="price-form">
                <div class="form-group">
                    <label>å•†å®¶é€£çµ</label>
                    <input 
                        type="url" 
                        id="modalStoreUrl"
                        class="store-url-input"
                    >
                    <span id="modalUrlValidation" class="url-validation-message validation-message"></span>
                </div>
                <div id="modalStoreDetails" class="store-details-container hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¸½é‡‘é¡</label>
                            <input 
                                type="number" 
                                id="modalTotalPrice"
                                class="store-total-input"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        <div class="form-group">
                            <label>æ•¸é‡</label>
                            <input 
                                type="number" 
                                id="modalQuantity"
                                class="store-quantity-input"
                                min="1"
                                step="1"
                                value="1"
                            >
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é‹è²»é‡‘é¡</label>
                            <input 
                                type="number" 
                                id="modalShipping"
                                class="store-shipping-input"
                                min="0"
                                step="0.01"
                                value=""
                            >
                        </div>
                        <div class="form-group">
                            <label>å„ªæƒ é‡‘é¡</label>
                            <input 
                                type="number" 
                                id="modalCoupon"
                                class="store-coupon-input"
                                min="0"
                                step="0.01"
                                value=""
                            >
                        </div>
                    </div>
                    <div class="form-group price-calculation-box">
                        <div class="price-calculation-row">
                            <div class="price-calculation-item">
                                <span class="price-calculation-label">å•†å“å–®åƒ¹ï¼š</span>
                                <span id="modalCalculatedPrice" class="price-calculation-value">-</span>
                            </div>
                            <div class="price-calculation-item">
                                <span class="price-calculation-label">å•†å“ç¸½åƒ¹ï¼š</span>
                                <span id="modalCalculatedTotal" class="price-calculation-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-flex">æ–°å¢</button>
                    <button type="button" class="btn btn-secondary btn-flex" onclick="closeAddStoreModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
// Firebase é…ç½®
const firebaseConfig = {
    apiKey: (window.__FIREBASE_API_KEY_PRICETOOLS__ || "").trim() || undefined,
    authDomain: "pricetools.firebaseapp.com",
    projectId: "pricetools",
    storageBucket: "pricetools.firebasestorage.app",
    messagingSenderId: "261643182004",
    appId: "1:261643182004:web:e36a9e6982091502071ce1",
    measurementId: "G-R71H1BTXM0"
};

// åˆå§‹åŒ– Firebase
let db = null;
let storage = null;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    storage = firebase.storage();
} catch (error) {
}

// å…¨å±€è®Šé‡
let priceData = [];
let storeGroupCounter = 0;
let useFirebase = false;
let isAddingStoreGroup = false;

// æª¢æŸ¥ Firebase æ˜¯å¦å¯ç”¨
if (db) {
    useFirebase = true;
} else {
}

// å¾ Firestore åŠ è¼‰æ•¸æ“šï¼ˆæŒ‰å•†å“åç¨±åŠ è¼‰æ‰€æœ‰æ–‡æª”ï¼‰
const loadDataFromFirestore = async () => {
    if (!db) return false;
    
    try {
        const snapshot = await db.collection('ç«¶åƒ¹å·¥å…·').get();
        priceData = [];
        let hasOldFormat = false;
        
        snapshot.forEach((doc) => {
            // æª¢æŸ¥æ˜¯å¦ç‚ºèˆŠæ ¼å¼ï¼ˆuserData æ–‡æª”ï¼‰
            if (doc.id === 'userData') {
                hasOldFormat = true;
                const data = doc.data();
                if (data.records && Array.isArray(data.records)) {
                    priceData.push(...data.records);
                }
            } else {
                // æ–°æ ¼å¼ï¼šæŒ‰å•†å“åç¨±åˆ†çµ„
                const data = doc.data();
                if (data.records && Array.isArray(data.records)) {
                    priceData.push(...data.records);
                }
            }
        });
        
        // å¦‚æœç™¼ç¾èˆŠæ ¼å¼ï¼Œé·ç§»åˆ°æ–°æ ¼å¼
        if (hasOldFormat && priceData.length > 0) {
            await saveDataToFirestore();
            try {
                await db.collection('ç«¶åƒ¹å·¥å…·').doc('userData').delete();
            } catch (e) {
            }
        }
        
        renderComparisonList();
        return true;
    } catch (error) {
    }
    return false;
};

// ä¿å­˜æ•¸æ“šåˆ° Firestoreï¼ˆæŒ‰å•†å“åç¨±åˆ†çµ„ä¿å­˜ï¼‰
const saveDataToFirestore = async () => {
    if (!db) return false;
    
    try {
        // æŒ‰å•†å“åç¨±åˆ†çµ„
        const groupedByProduct = {};
        priceData.forEach(record => {
            const productName = record.productName || 'æœªåˆ†é¡å•†å“';
            if (!groupedByProduct[productName]) {
                groupedByProduct[productName] = [];
            }
            groupedByProduct[productName].push(record);
        });
        
        // ä½¿ç”¨æ‰¹æ¬¡å¯«å…¥æé«˜æ•ˆç‡
        const batch = db.batch();
        const productNames = Object.keys(groupedByProduct);
        
        // ç²å–ç¾æœ‰æ–‡æª”ï¼Œæ‰¾å‡ºéœ€è¦åˆªé™¤çš„å•†å“ï¼ˆå¦‚æœæŸå€‹å•†å“çš„æ‰€æœ‰è¨˜éŒ„éƒ½è¢«åˆªé™¤äº†ï¼‰
        const existingSnapshot = await db.collection('ç«¶åƒ¹å·¥å…·').get();
        const existingProductNames = new Set();
        existingSnapshot.forEach(doc => {
            existingProductNames.add(doc.id);
        });
        
        // ä¿å­˜æˆ–æ›´æ–°æ¯å€‹å•†å“çš„æ•¸æ“š
        productNames.forEach(productName => {
            const productRef = db.collection('ç«¶åƒ¹å·¥å…·').doc(productName);
            batch.set(productRef, {
                records: groupedByProduct[productName],
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        // åˆªé™¤å·²ä¸å­˜åœ¨çš„å•†å“æ–‡æª”ï¼ˆå¦‚æœæŸå€‹å•†å“çš„æ‰€æœ‰è¨˜éŒ„éƒ½è¢«åˆªé™¤äº†ï¼‰
        productNames.forEach(productName => {
            existingProductNames.delete(productName);
        });
        existingProductNames.forEach(productName => {
            const productRef = db.collection('ç«¶åƒ¹å·¥å…·').doc(productName);
            batch.delete(productRef);
        });
        
        await batch.commit();
        return true;
    } catch (error) {
        return false;
    }
};

// å·¥å…·å‡½æ•¸
const loadData = async () => {
    if (useFirebase) {
        // å˜—è©¦å¾ Firestore åŠ è¼‰
        const loaded = await loadDataFromFirestore();
        if (loaded) {
            // å¦‚æœæˆåŠŸå¾ Firestore åŠ è¼‰ï¼Œå˜—è©¦é·ç§» localStorage æ•¸æ“šï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const saved = localStorage.getItem('priceComparisonData');
            if (saved) {
                try {
                    const localData = JSON.parse(saved);
                    // å¦‚æœ Firestore æ•¸æ“šç‚ºç©ºä½† localStorage æœ‰æ•¸æ“šï¼Œé€²è¡Œé·ç§»
                    if (priceData.length === 0 && localData.length > 0) {
                        priceData = localData;
                        await saveDataToFirestore();
                        localStorage.removeItem('priceComparisonData');
                    }
                } catch (e) {
                }
            }
            return;
        }
    }
    
    // ä½¿ç”¨ localStorage ä½œç‚ºå¾Œå‚™
    const saved = localStorage.getItem('priceComparisonData');
    if (saved) {
        try {
            priceData = JSON.parse(saved);
            renderComparisonList();
        } catch (e) {
        }
    }
};

const saveData = async () => {
    if (useFirebase) {
        // å˜—è©¦ä¿å­˜åˆ° Firestore
        const saved = await saveDataToFirestore();
        if (saved) {
            // åŒæ™‚ä¿å­˜åˆ° localStorage ä½œç‚ºå‚™ä»½
            try {
                localStorage.setItem('priceComparisonData', JSON.stringify(priceData));
            } catch (e) {
            }
            return;
        }
    }
    
    // ä½¿ç”¨ localStorage ä½œç‚ºå¾Œå‚™
    try {
        localStorage.setItem('priceComparisonData', JSON.stringify(priceData));
    } catch (e) {
    }
};

const roundToTwoDecimals = (value) => Math.round((value || 0) * 100) / 100;

const formatNumber = (value) => {
    const rounded = roundToTwoDecimals(value);
    return rounded % 1 === 0 ? rounded.toString() : rounded.toFixed(2);
};

// é€šç”¨çš„è¼¸å…¥æ¡†äº‹ä»¶ç¶å®šå‡½æ•¸
const bindNumberInputEvents = (inputs, calculateCallback, onBlurCallback = null) => {
    inputs.forEach(input => {
        input.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                e.target.value = formatNumber(value);
            }
            calculateCallback();
            if (onBlurCallback) onBlurCallback(input, e);
        });
        input.addEventListener('input', calculateCallback);
    });
};

// é€šç”¨çš„è¼¸å…¥æ¡†å…‹éš†å‡½æ•¸
const cloneInputElements = (inputIds) => {
    const cloned = {};
    inputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            const clonedInput = input.cloneNode(true);
            input.parentNode.replaceChild(clonedInput, input);
            cloned[id] = document.getElementById(id);
        }
    });
    return cloned;
};

// å¾è¡¨å–®å…ƒç´ ç²å–åƒ¹æ ¼æ•¸æ“š
const getFormPriceData = (urlId, totalId, quantityId, shippingId, couponId) => {
    const storeUrl = document.getElementById(urlId)?.value.trim() || '';
    const totalPrice = roundToTwoDecimals(parseFloat(document.getElementById(totalId)?.value || 0));
    const quantity = parseInt(document.getElementById(quantityId)?.value || 1);
    const shippingCost = roundToTwoDecimals(parseFloat(document.getElementById(shippingId)?.value || 0));
    const couponAmount = roundToTwoDecimals(parseFloat(document.getElementById(couponId)?.value || 0));
    const { productPrice, productUnitPrice } = calculatePrice(totalPrice, quantity, shippingCost);
    
    return {
        storeUrl,
        totalPrice,
        quantity,
        shippingCost,
        couponAmount,
        productPrice,
        unitPrice: productUnitPrice,
        finalPrice: totalPrice
    };
};

// é©—è­‰åƒ¹æ ¼è¡¨å–®æ•¸æ“š
const validatePriceFormData = (data) => {
    if (!data.storeUrl || isNaN(data.totalPrice) || data.totalPrice <= 0 || data.quantity < 1) {
        return { valid: false, message: 'è«‹å¡«å¯«å®Œæ•´çš„åº—å®¶è³‡è¨Šï¼ˆå•†å®¶é€£çµã€ç¸½é‡‘é¡ã€æ•¸é‡ï¼‰' };
    }
    return { valid: true, message: '' };
};

// é€šç”¨çš„URLé©—è­‰å’Œé¡¯ç¤ºå‡½æ•¸
const validateAndShowUrl = (urlInput, urlValidationMessage, detailsContainer, excludeRecordId = null, currentIndex = null) => {
    const url = urlInput.value.trim();
    if (!url) {
        urlValidationMessage.style.display = 'none';
        urlInput.style.borderColor = '';
        if (detailsContainer) detailsContainer.classList.add('hidden');
        return false;
    }
    
    const urlValidation = validateUrl(url);
    if (!urlValidation.valid) {
        urlValidationMessage.textContent = urlValidation.message;
        urlValidationMessage.style.display = 'block';
        urlInput.style.borderColor = '#ef5350';
        if (detailsContainer) detailsContainer.classList.add('hidden');
        return false;
    }
    
    const duplicateCheck = checkDuplicateUrl(url, excludeRecordId, currentIndex);
    if (duplicateCheck.isDuplicate) {
        urlValidationMessage.textContent = duplicateCheck.message;
        urlValidationMessage.style.display = 'block';
        urlInput.style.borderColor = '#ef5350';
        if (detailsContainer) detailsContainer.classList.add('hidden');
        return false;
    }
    
    urlValidationMessage.style.display = 'none';
    urlInput.style.borderColor = '';
    if (detailsContainer) detailsContainer.classList.remove('hidden');
    return true;
};

// å¾å‰ªè²¼ç°¿å–å¾—ç¬¬ä¸€å€‹åœ–ç‰‡æª”ï¼Œç„¡å‰‡å›å‚³ null
const getImageFileFromClipboard = (e) => {
    const items = e.clipboardData?.items;
    if (!items?.length) return null;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            if (!blob) return null;
            return new File([blob], `pasted-image-${Date.now()}.png`, { type: blob.type || 'image/png' });
        }
    }
    return null;
};

const findProductImageUrl = (productName, originalRecord = null) => {
    if (originalRecord?.productImageUrl) return originalRecord.productImageUrl;
    const existingRecord = priceData.find(r => r.productName === productName && r.productImageUrl);
    return existingRecord?.productImageUrl || null;
};

// å‰µå»ºåƒ¹æ ¼è¨˜éŒ„å°è±¡
const createPriceRecord = (productName, formData, id = null, productImageUrl = null) => {
    return {
        id: id || (Date.now() + Math.random()),
        productName,
        storeUrl: formData.storeUrl,
        productImageUrl: productImageUrl || null,
        productPrice: formData.productPrice,
        quantity: formData.quantity,
        shippingCost: formData.shippingCost,
        couponAmount: formData.couponAmount,
        finalPrice: formData.finalPrice,
        unitPrice: formData.unitPrice
    };
};

// é€šç”¨çš„å½ˆå‡ºè¦–çª—å¤–éƒ¨é»æ“Šé—œé–‰
const setupModalOutsideClick = (modalId, closeCallback) => {
    const modal = document.getElementById(modalId);
    modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeCallback();
    });
};

const formatPriceDisplay = (value) => {
    const formatted = formatNumber(value);
    const parts = formatted.split('.');
    const integerPart = parseInt(parts[0]).toLocaleString('zh-TW');
    return parts.length > 1 ? `${integerPart}.${parts[1]}` : integerPart;
};

const tryParseUrl = (url) => {
    try {
        // æ”¯æ´ http:// å’Œ https:// é–‹é ­çš„ URL
        return { url: new URL(url), valid: true };
    } catch (e) {
        if (!url.includes('://')) {
            try {
                // å¦‚æœæ²’æœ‰å”è­°ï¼Œé è¨­æ·»åŠ  http://
                return { url: new URL('http://' + url), valid: true };
            } catch (e2) {
                return { valid: false };
            }
        }
        return { valid: false };
    }
};

const validateUrl = (url) => {
    if (!url || !url.trim()) return { valid: false, message: '' };
    
    const trimmedUrl = url.trim();
    // æª¢æŸ¥æ˜¯å¦ä»¥ http:// æˆ– https:// é–‹é ­
    const lowerUrl = trimmedUrl.toLowerCase();
    if (!lowerUrl.startsWith('http://') && !lowerUrl.startsWith('https://')) {
        return { valid: false, message: 'è«‹è²¼ä¸Šé€£çµï¼ˆéœ€ä»¥ http:// æˆ– https:// é–‹é ­ï¼‰' };
    }
    
    const result = tryParseUrl(url);
    return result.valid 
        ? { valid: true, message: '' }
        : { valid: false, message: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€é€£çµï¼ˆä¾‹å¦‚ï¼šhttps://example.comï¼‰' };
};

const normalizeUrl = (url) => {
    if (!url || !url.trim()) return '';
    const result = tryParseUrl(url);
    return result.valid ? result.url.href.toLowerCase() : url.trim().toLowerCase();
};

const extractDomainFromUrl = (url) => {
    const result = tryParseUrl(url);
    if (!result.valid) return url;
    let domain = result.url.hostname;
    return domain.startsWith('www.') ? domain.substring(4) : domain;
};

const getStorePlatformIcon = (url) => {
    const urlLower = url.toLowerCase();
    if (urlLower.includes('1688.com')) {
        return '<span class="store-platform-icon platform-1688">1688</span>';
    } else if (urlLower.includes('tmall.com')) {
        return '<span class="store-platform-icon platform-tmall">å¤©è²“</span>';
    } else if (urlLower.includes('taobao.com')) {
        return '<span class="store-platform-icon platform-taobao">æ·˜å¯¶</span>';
    }
    return null;
};

const isUrlForProductName = (str) => {
    const trimmed = str.trim();
    // åªæª¢æŸ¥æ˜é¡¯çš„ URL æ ¼å¼ï¼šä»¥ http:// æˆ– https:// é–‹é ­
    if (trimmed.toLowerCase().startsWith('http://') || trimmed.toLowerCase().startsWith('https://')) {
        return true;
    }
    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„åŸŸåæ ¼å¼ï¼ˆåŒ…å«å¸¸è¦‹çš„é ‚ç´šåŸŸåï¼Œä¸”ä¸åŒ…å«ç©ºæ ¼ï¼‰
    if (!trimmed.includes(' ')) {
        const domainWithTldPattern = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*\.(com|net|org|edu|gov|tw|cn|jp|kr|uk|de|fr|it|es|ru|au|ca|mx|br|in|id|ph|sg|my|vn|th|hk|mo|io|co|me|info|biz)(\.[a-z]{2})?(\/.*)?$/i;
        return domainWithTldPattern.test(trimmed);
    }
    return false;
};

const createStoreGroup = (index) => {
    return `
        <div class="store-group" data-store-index="${index}">
            <div class="form-group">
                <label>å•†å®¶é€£çµ</label>
                <input 
                    type="url" 
                    class="store-url-input"
                    data-store-index="${index}"
                >
                <span class="url-validation-message validation-message" data-store-index="${index}"></span>
            </div>
            <div class="store-details-container hidden" data-store-index="${index}">
                <div class="form-row">
                    <div class="form-group">
                        <label>ç¸½é‡‘é¡</label>
                        <input 
                            type="number" 
                            class="store-total-input"
                            data-store-index="${index}"
                            min="0"
                            step="0.01"
                        >
                    </div>
                    <div class="form-group">
                        <label>æ•¸é‡</label>
                        <input 
                            type="number" 
                            class="store-quantity-input"
                            data-store-index="${index}"
                            min="1"
                            step="1"
                            value="1"
                        >
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é‹è²»é‡‘é¡</label>
                        <input 
                            type="number" 
                            class="store-shipping-input"
                            data-store-index="${index}"
                            min="0"
                            step="0.01"
                            value=""
                        >
                    </div>
                    <div class="form-group">
                        <label>å„ªæƒ é‡‘é¡</label>
                        <input 
                            type="number" 
                            class="store-coupon-input"
                            data-store-index="${index}"
                            min="0"
                            step="0.01"
                            value=""
                        >
                    </div>
                </div>
                <div class="form-group price-calculation-box">
                    <div class="price-calculation-row">
                        <div class="price-calculation-item">
                            <span class="price-calculation-label">å•†å“å–®åƒ¹ï¼š</span>
                            <span class="store-calculated-price price-calculation-value" data-store-index="${index}">-</span>
                        </div>
                        <div class="price-calculation-item">
                            <span class="price-calculation-label">å•†å“ç¸½åƒ¹ï¼š</span>
                            <span class="store-calculated-total price-calculation-value" data-store-index="${index}">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
};

// é€šç”¨åƒ¹æ ¼è¨ˆç®—å‡½æ•¸
const calculatePrice = (totalPrice, quantity, shippingCost = 0) => {
    const productPrice = roundToTwoDecimals(totalPrice - shippingCost);
    const productUnitPrice = quantity > 0 ? roundToTwoDecimals(productPrice / quantity) : 0;
    return { productPrice, productUnitPrice };
};

// æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
const updatePriceDisplay = (calculatedTotalEl, calculatedPriceEl, productPrice, productUnitPrice, quantity) => {
    if (calculatedTotalEl) {
        calculatedTotalEl.textContent = productPrice > 0 ? formatPriceDisplay(productPrice) : '-';
    }
    if (calculatedPriceEl) {
        calculatedPriceEl.textContent = (productPrice > 0 && quantity > 0) ? formatPriceDisplay(productUnitPrice) : '-';
    }
};

const calculateProductPrice = (group) => {
    const totalPrice = parseFloat(group.querySelector('.store-total-input')?.value) || 0;
    const quantity = parseInt(group.querySelector('.store-quantity-input')?.value) || 1;
    const shippingInput = group.querySelector('.store-shipping-input');
    const couponInput = group.querySelector('.store-coupon-input');
    
    const shippingCost = roundToTwoDecimals(parseFloat(shippingInput?.value) || 0);
    const couponAmount = roundToTwoDecimals(parseFloat(couponInput?.value) || 0);
    const { productPrice, productUnitPrice } = calculatePrice(totalPrice, quantity, shippingCost);
    
    const calculatedTotalEl = group.querySelector('.store-calculated-total');
    const calculatedPriceEl = group.querySelector('.store-calculated-price');
    updatePriceDisplay(calculatedTotalEl, calculatedPriceEl, productPrice, productUnitPrice, quantity);
    
    return { productPrice, shippingCost, couponAmount, quantity };
};

// æª¢æŸ¥URLæ˜¯å¦é‡è¤‡ï¼ˆå…¨åŸŸæª¢æ¸¬ï¼‰
const checkDuplicateUrl = (url, excludeRecordId = null, currentIndex = null) => {
    if (!url || !url.trim()) return { isDuplicate: false, message: '' };
    
    const normalizedUrl = normalizeUrl(url);
    
    // å¦‚æœæä¾›äº†currentIndexï¼Œæª¢æŸ¥è¡¨å–®ä¸­çš„é‡è¤‡ï¼ˆæ–°å¢è¡¨å–®å…§çš„æª¢æ¸¬ï¼‰
    if (currentIndex !== null) {
        const allGroups = document.querySelectorAll('.store-group');
        for (const otherGroup of allGroups) {
            const otherIndex = parseInt(otherGroup.getAttribute('data-store-index'));
            if (otherIndex !== currentIndex) {
                const otherUrlInput = otherGroup.querySelector('.store-url-input');
                if (otherUrlInput?.value.trim() && normalizeUrl(otherUrlInput.value.trim()) === normalizedUrl) {
                    return { isDuplicate: true, message: 'é€£çµé‡è¤‡è«‹è²¼ä¸Šæ–°é€£çµ' };
                }
            }
        }
    }
    
    // å…¨åŸŸæª¢æ¸¬ï¼šæª¢æŸ¥priceDataä¸­æ‰€æœ‰å•†å“çš„é€£çµ
    if (priceData && priceData.length > 0) {
        const existingRecord = priceData.find(record => {
            // æ’é™¤ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„è¨˜éŒ„
            if (excludeRecordId && record.id === excludeRecordId) return false;
            return record.storeUrl && normalizeUrl(record.storeUrl) === normalizedUrl;
        });
        if (existingRecord) {
            return { isDuplicate: true, message: 'é€£çµé‡è¤‡è«‹è²¼ä¸Šæ–°é€£çµ' };
        }
    }
    
    return { isDuplicate: false, message: '' };
};

const addStoreGroup = () => {
    const storesList = document.getElementById('storesList');
    const index = storeGroupCounter++;
    storesList.insertAdjacentHTML('beforeend', createStoreGroup(index));
    
    const group = storesList.querySelector(`[data-store-index="${index}"]`);
    
    // ç‚ºæ–°æ·»åŠ çš„è¼¸å…¥æ¡†è¨­ç½® Delete éµè¡Œç‚º
    setupInputDeleteBehavior(group);
    const totalInput = group.querySelector('.store-total-input');
    const quantityInput = group.querySelector('.store-quantity-input');
    const shippingInput = group.querySelector('.store-shipping-input');
    const couponInput = group.querySelector('.store-coupon-input');
    const urlInput = group.querySelector('.store-url-input');
    const urlValidationMessage = group.querySelector('.url-validation-message');
    const detailsContainer = group.querySelector('.store-details-container');
    
    // é˜²æŠ–è¨ˆæ™‚å™¨ï¼Œç”¨æ–¼å„ªåŒ–è¼¸å…¥é©—è­‰æ€§èƒ½
    let inputDebounceTimer = null;
    
    const validateStoreUrlInput = () => {
        validateAndShowUrl(urlInput, urlValidationMessage, detailsContainer, null, index);
    };
    
    const checkAndAddNextStoreGroup = () => {
        if (isAddingStoreGroup) {
            return;
        }
        const url = urlInput.value.trim();
        if (!url) return;
        
        const urlValidation = validateUrl(url);
        if (!urlValidation.valid) return;
        
        const duplicateCheck = checkDuplicateUrl(url, null, index);
        if (duplicateCheck.isDuplicate) return;
        
        const allGroups = storesList.querySelectorAll('.store-group');
        const isLastGroup = Array.from(allGroups).indexOf(group) === allGroups.length - 1;
        if (isLastGroup) {
            // æª¢æŸ¥æ˜¯å¦è¦æ·»åŠ ç¬¬äºŒçµ„æˆ–æ›´å¤šçµ„
            // å¦‚æœç•¶å‰çµ„ç´¢å¼• >= 0ï¼ˆå³è‡³å°‘æ˜¯ç¬¬ä¸€çµ„ï¼‰ï¼Œæª¢æŸ¥ç•¶å‰çµ„çš„ç¸½é‡‘é¡å’Œæ•¸é‡
            const currentGroupIndex = Array.from(allGroups).indexOf(group);
            if (currentGroupIndex >= 0) {
                // ç²å–ç•¶å‰çµ„çš„ç¸½é‡‘é¡å’Œæ•¸é‡è¼¸å…¥æ¡†
                const currentTotalInput = group.querySelector('.store-total-input');
                const currentQuantityInput = group.querySelector('.store-quantity-input');
                
                const totalPrice = parseFloat(currentTotalInput?.value) || 0;
                const quantity = parseInt(currentQuantityInput?.value) || 0;
                
                // å¦‚æœç¸½é‡‘é¡ <= 0 æˆ–æ•¸é‡ <= 0ï¼Œå‰‡ä¸å…è¨±æ·»åŠ ä¸‹ä¸€çµ„
                if (totalPrice <= 0 || quantity <= 0) {
                    return;
                }
            }
            
            isAddingStoreGroup = true;
            setTimeout(() => {
                addStoreGroup();
                isAddingStoreGroup = false;
            }, 0);
        }
    };
    
    // ç•¶ç¸½é‡‘é¡æˆ–æ•¸é‡è¼¸å…¥æ™‚ï¼Œä¹Ÿæª¢æŸ¥æ˜¯å¦æ‡‰è©²æ·»åŠ ä¸‹ä¸€çµ„
    const checkAndAddNextStoreGroupOnPriceInput = () => {
        // å»¶é²æª¢æŸ¥ï¼Œé¿å…åœ¨è¼¸å…¥éç¨‹ä¸­é »ç¹è§¸ç™¼
        if (checkAndAddNextStoreGroupOnPriceInput.timer) {
            clearTimeout(checkAndAddNextStoreGroupOnPriceInput.timer);
        }
        checkAndAddNextStoreGroupOnPriceInput.timer = setTimeout(() => {
            checkAndAddNextStoreGroup();
        }, 300);
    };
    
    urlInput.addEventListener('blur', () => {
        // æ¸…é™¤é˜²æŠ–è¨ˆæ™‚å™¨ï¼Œç«‹å³é©—è­‰
        if (inputDebounceTimer) {
            clearTimeout(inputDebounceTimer);
            inputDebounceTimer = null;
        }
        validateStoreUrlInput();
        checkAndAddNextStoreGroup();
    });
    
    urlInput.addEventListener('input', () => {
        // ä½¿ç”¨é˜²æŠ–æ©Ÿåˆ¶ï¼Œé¿å…é »ç¹é©—è­‰å°è‡´è¨˜æ†¶é«”å•é¡Œ
        if (inputDebounceTimer) {
            clearTimeout(inputDebounceTimer);
        }
        // å°æ–¼ URL è¼¸å…¥ï¼Œä½¿ç”¨è¼ƒçŸ­çš„å»¶é²ï¼ˆ300msï¼‰
        inputDebounceTimer = setTimeout(() => {
            validateStoreUrlInput();
            // è²¼ä¸Šé€£çµå¾Œè‡ªå‹•è·³å‡ºä¸‹ä¸€çµ„
            checkAndAddNextStoreGroup();
            inputDebounceTimer = null;
        }, 300);
    });
    
    // æ·»åŠ  paste äº‹ä»¶ç›£è½å™¨ï¼Œè²¼ä¸Šæ™‚ç«‹å³è™•ç†
    // æ³¨æ„ï¼šæ­¤äº‹ä»¶ç›£è½å™¨å°æ–¼è²¼ä¸ŠåŠŸèƒ½è‡³é—œé‡è¦ï¼Œè«‹å‹¿ç§»é™¤æˆ–ä¿®æ”¹
    urlInput.addEventListener('paste', (e) => {
        // æ¸…é™¤é˜²æŠ–è¨ˆæ™‚å™¨ï¼Œé¿å…èˆ‡ input äº‹ä»¶è¡çª
        if (inputDebounceTimer) {
            clearTimeout(inputDebounceTimer);
            inputDebounceTimer = null;
        }
        // ä½¿ç”¨è¼ƒé•·çš„å»¶é²ç¢ºä¿è²¼ä¸Šçš„å…§å®¹å·²ç¶“å®Œå…¨å¯«å…¥è¼¸å…¥æ¡†
        // 50ms æ˜¯ç¶“éæ¸¬è©¦çš„æœ€ä½³å€¼ï¼Œå¤ªçŸ­å¯èƒ½ç„¡æ³•ç²å–åˆ°è²¼ä¸Šçš„å…§å®¹
        setTimeout(() => {
            if (urlInput.value.trim()) {
                validateStoreUrlInput();
                checkAndAddNextStoreGroup();
            }
        }, 50);
    });
    
    // ç•¶å•†å“åç¨±æˆ–å…¶ä»–åº—å®¶çµ„çš„URLæ”¹è®Šæ™‚ï¼Œé‡æ–°é©—è­‰ç•¶å‰URLï¼ˆç”¨æ–¼æª¢æ¸¬é‡è¤‡ï¼‰
    // å„ªåŒ–ï¼šä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œåªåœ¨å¤±å»ç„¦é»æ™‚è§¸ç™¼å…¶ä»–è¼¸å…¥æ¡†çš„é©—è­‰ï¼Œé¿å…é€£é–åæ‡‰å’Œè¨˜æ†¶é«”å•é¡Œ
    // ç§»é™¤åŸä¾†çš„é€£é–é©—è­‰é‚è¼¯ï¼Œæ”¹ç”¨æ›´é«˜æ•ˆçš„æ–¹å¼
    
    // ç¶å®šè¼¸å…¥æ¡†çš„å››æ¨äº”å…¥äº‹ä»¶
    [totalInput, shippingInput, couponInput].forEach(input => {
        input.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                e.target.value = formatNumber(value);
            }
            calculateProductPrice(group);
            // ç•¶ç¸½é‡‘é¡è¼¸å…¥å®Œæˆå¾Œï¼Œæª¢æŸ¥æ˜¯å¦æ‡‰è©²æ·»åŠ ä¸‹ä¸€çµ„
            if (input === totalInput) {
                checkAndAddNextStoreGroupOnPriceInput();
            }
        });
        input.addEventListener('input', () => {
            calculateProductPrice(group);
        });
    });
    
    quantityInput.addEventListener('input', () => {
        calculateProductPrice(group);
    });
    
    quantityInput.addEventListener('blur', () => {
        // ç•¶æ•¸é‡è¼¸å…¥å®Œæˆå¾Œï¼Œæª¢æŸ¥æ˜¯å¦æ‡‰è©²æ·»åŠ ä¸‹ä¸€çµ„
        checkAndAddNextStoreGroupOnPriceInput();
    });
    
    // åˆå§‹è¨ˆç®—
    calculateProductPrice(group);
}

// åˆå§‹åŒ–è¡¨å–®äº‹ä»¶
function initForm() {
    const form = document.getElementById('priceForm');
    const productNameInput = document.getElementById('productName');
    const storesContainer = document.getElementById('storesContainer');
    const resetBtn = document.getElementById('resetBtn');
    // å•†å“åç¨±è¼¸å…¥é©—è­‰
    const productNameValidation = document.getElementById('productNameValidation');
    
    const validateProductNameField = () => {
        const productName = productNameInput.value.trim();
        const isUrl = productName && isUrlForProductName(productName);
        if (!productName) {
            productNameValidation.style.display = 'none';
            productNameInput.style.borderColor = '';
            storesContainer.classList.remove('active');
        } else if (isUrl) {
            productNameValidation.textContent = 'è«‹è¼¸å…¥æ­£ç¢ºçš„å•†å“åç¨±';
            productNameValidation.style.display = 'block';
            productNameInput.style.borderColor = '#ef5350';
            storesContainer.classList.remove('active');
        } else {
            productNameValidation.style.display = 'none';
            productNameInput.style.borderColor = '';
            storesContainer.classList.add('active');
            if (document.querySelectorAll('.store-group').length === 0) addStoreGroup();
        }
    };
    productNameInput.addEventListener('input', validateProductNameField);
    productNameInput.addEventListener('blur', validateProductNameField);

    // è¡¨å–®æäº¤
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        addAllPriceRecords();
    });

    // é‡ç½®è¡¨å–®
    resetBtn.addEventListener('click', () => {
        form.reset();
        document.getElementById('storesList').innerHTML = '';
        storesContainer.classList.remove('active');
        storeGroupCounter = 0;
        // é‡ç½®åœ–ç‰‡ä¸Šå‚³
        resetImageUpload();
    });

    // åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
    initImageUpload();
}

// åœ–ç‰‡ä¸Šå‚³ç›¸é—œè®Šé‡
let currentProductImageUrl = null;
let currentProductImageFile = null;

// è™•ç†åœ–ç‰‡æ–‡ä»¶çš„é€šç”¨å‡½æ•¸
function handleImageFile(file) {
    if (!file) return;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡æ–‡ä»¶
    if (!file.type.startsWith('image/')) {
        alert('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
        return;
    }
    
    currentProductImageFile = file;
    
    // é¡¯ç¤ºé è¦½
    const imagePreview = document.getElementById('productImagePreview');
    const imagePlaceholder = document.getElementById('productImagePlaceholder');
    const removeImageBtn = document.getElementById('removeImageBtn');
    
    const reader = new FileReader();
    reader.onload = (e) => {
        imagePreview.src = e.target.result;
        imagePreview.classList.remove('hidden');
        imagePlaceholder.classList.add('hidden');
        removeImageBtn.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}

// åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
function initImageUpload() {
    const imageInput = document.getElementById('productImage');
    const removeImageBtn = document.getElementById('removeImageBtn');
    const imagePreview = document.getElementById('productImagePreview');
    const imagePlaceholder = document.getElementById('productImagePlaceholder');
    const previewContainer = imagePreview.parentElement;
    const imageUploadContainer = previewContainer.parentElement;
    
    // é è¦½å®¹å™¨é»æ“Šé¸æ“‡åœ–ç‰‡ï¼ˆç„¡è«–æ˜¯å¦æœ‰åœ–ç‰‡éƒ½å¯ä»¥é»æ“Šä¸Šå‚³æˆ–æ›´æ›ï¼‰
    // ä½†æ’é™¤ç§»é™¤æŒ‰éˆ•çš„é»æ“Š
    previewContainer.addEventListener('click', (e) => {
        // å¦‚æœé»æ“Šçš„æ˜¯ç§»é™¤æŒ‰éˆ•ï¼Œä¸è§¸ç™¼æ–‡ä»¶é¸æ“‡
        if (e.target === removeImageBtn || e.target.closest('.image-remove-btn')) {
            return;
        }
        imageInput.click();
    });
    
    // æ–‡ä»¶é¸æ“‡
    imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        handleImageFile(file);
    });
    
    // ç§»é™¤åœ–ç‰‡ï¼ˆé˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼æ–‡ä»¶é¸æ“‡ï¼‰
    removeImageBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        resetImageUpload();
    });
    
    // è¤‡è£½è²¼ä¸Šåœ–ç‰‡åŠŸèƒ½
    // ä½¿ç”¨å…¨å±€ç›£è½ï¼Œä½†åªåœ¨ç„¦é»ä¸åœ¨è¼¸å…¥æ¡†æ™‚è™•ç†åœ–ç‰‡è²¼ä¸Š
    let pasteHandler = (e) => {
        // å¦‚æœåœ–ç‰‡æŸ¥çœ‹å½ˆå‡ºè¦–çª—æ‰“é–‹ï¼Œä¸è™•ç†è²¼ä¸Šï¼ˆè®“åœ–ç‰‡æŸ¥çœ‹å½ˆå‡ºè¦–çª—çš„è™•ç†å™¨è™•ç†ï¼‰
        const imageViewModal = document.getElementById('imageViewModal');
        if (imageViewModal && imageViewModal.classList.contains('active')) {
            return;
        }
        
        // å¦‚æœç„¦é»åœ¨è¼¸å…¥æ¡†æˆ–æ–‡å­—å€åŸŸï¼Œä¸è™•ç†åœ–ç‰‡è²¼ä¸Šï¼ˆè®“ç”¨æˆ¶æ­£å¸¸è¼¸å…¥ï¼‰
        const activeElement = document.activeElement;
        if (activeElement && (
            activeElement.tagName === 'INPUT' || 
            activeElement.tagName === 'TEXTAREA' ||
            activeElement.isContentEditable
        )) {
            // ä½†å¦‚æœè¼¸å…¥æ¡†æ˜¯åœ–ç‰‡é¸æ“‡å™¨ï¼Œå‰‡å¯ä»¥è™•ç†
            if (activeElement.type !== 'file') {
                return;
            }
        }
        
        const file = getImageFileFromClipboard(e);
        if (!file) return;
        e.preventDefault();
        handleImageFile(file);
        if (!imagePreview.src || imagePreview.classList.contains('hidden')) {
            const placeholderText = imagePlaceholder.querySelector('span');
            if (placeholderText) {
                const originalText = placeholderText.innerHTML;
                placeholderText.style.color = 'var(--success)';
                placeholderText.innerHTML = 'âœ“ åœ–ç‰‡å·²è²¼ä¸Šï¼<br><small style="font-size: 0.85em; opacity: 0.7;">é»æ“Šå¯æ›´æ›åœ–ç‰‡</small>';
                setTimeout(() => {
                    placeholderText.innerHTML = originalText;
                    placeholderText.style.color = '';
                }, 2000);
            }
        }
    };
    
    // åœ¨æ–‡æª”ä¸Šç›£è½è²¼ä¸Šäº‹ä»¶ï¼ˆå…¨å±€ï¼‰
    document.addEventListener('paste', pasteHandler);
    
    // æ·»åŠ æç¤ºæ–‡å­—èªªæ˜æ”¯æ´è²¼ä¸ŠåŠŸèƒ½
    const placeholderText = imagePlaceholder.querySelector('span');
    if (placeholderText) {
        placeholderText.innerHTML = 'æ–°å¢åœ–ç‰‡';
    }
}

// é‡ç½®åœ–ç‰‡ä¸Šå‚³
function resetImageUpload() {
    const imageInput = document.getElementById('productImage');
    const imagePreview = document.getElementById('productImagePreview');
    const imagePlaceholder = document.getElementById('productImagePlaceholder');
    const removeImageBtn = document.getElementById('removeImageBtn');
    const uploadProgress = document.getElementById('imageUploadProgress');
    
    imageInput.value = '';
    imagePreview.src = '';
    imagePreview.classList.add('hidden');
    imagePlaceholder.classList.remove('hidden');
    removeImageBtn.classList.add('hidden');
    uploadProgress.classList.add('hidden');
    currentProductImageUrl = null;
    currentProductImageFile = null;
    
    // æ¢å¾©æç¤ºæ–‡å­—
    const placeholderText = imagePlaceholder.querySelector('span');
    if (placeholderText) {
        placeholderText.innerHTML = 'æ–°å¢åœ–ç‰‡';
        placeholderText.style.color = '';
    }
}

// é€šç”¨ï¼šä¸Šå‚³åœ–ç‰‡åˆ° Firebase Storageï¼Œå¯é¸é€²åº¦æ¢ï¼ˆå‚³å…¥ { containerId, fillId, textId }ï¼‰
async function uploadImageToStorage(file, progressIds = null) {
    if (!storage || !file) return null;
    const container = progressIds ? document.getElementById(progressIds.containerId) : null;
    const progressFill = progressIds ? document.getElementById(progressIds.fillId) : null;
    const progressText = progressIds ? document.getElementById(progressIds.textId) : null;
    const showProgress = (pct, text) => {
        if (progressFill) progressFill.style.width = (pct || 0) + '%';
        if (progressText) progressText.textContent = text || 'ä¸Šå‚³ä¸­...';
    };
    const hideProgress = () => { if (container) container.classList.add('hidden'); };
    try {
        if (container) {
            container.classList.remove('hidden');
            showProgress(0, 'ä¸Šå‚³ä¸­...');
        }
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(2, 15);
        const fileExt = file.name.split('.').pop();
        const fileName = `product-images/${timestamp}_${randomStr}.${fileExt}`;
        const storageRef = storage.ref().child(fileName);
        const uploadTask = storageRef.put(file);
        uploadTask.on('state_changed',
            (snapshot) => {
                const pct = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                showProgress(pct, `ä¸Šå‚³ä¸­... ${Math.round(pct)}%`);
            },
            (error) => {
                hideProgress();
                alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        );
        await uploadTask;
        const downloadURL = await storageRef.getDownloadURL();
        hideProgress();
        return downloadURL;
    } catch (error) {
        hideProgress();
        throw error;
    }
}

async function uploadProductImage(file) {
    const url = await uploadImageToStorage(file, {
        containerId: 'imageUploadProgress',
        fillId: 'progressFill',
        textId: 'progressText'
    });
    if (url) currentProductImageUrl = url;
    return url;
}

// æ–°å¢æ‰€æœ‰æ¯”åƒ¹è¨˜éŒ„
async function addAllPriceRecords() {
    const productName = document.getElementById('productName').value.trim();
    
    if (!productName) {
        alert('è«‹å¡«å¯«å•†å“åç¨±');
        return;
    }
    
    // æª¢æŸ¥å•†å“åç¨±æ˜¯å¦ç‚ºé€£çµ
    if (isUrlForProductName(productName)) {
        alert('è«‹è¼¸å…¥æ­£ç¢ºçš„å•†å“åç¨±');
        document.getElementById('productName').focus();
        return;
    }

    // ä¸Šå‚³åœ–ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
    let productImageUrl = null;
    if (currentProductImageFile) {
        try {
            productImageUrl = await uploadProductImage(currentProductImageFile);
        } catch (error) {
            alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            return;
        }
    }

    const storeGroups = document.querySelectorAll('.store-group');
    const newRecords = [];
    const invalidGroups = []; // è¨˜éŒ„æœ‰å•†å®¶é€£çµä½†ç¸½é‡‘é¡æˆ–æ•¸é‡æœªå¡«çš„åº—å®¶çµ„
    
    // è™•ç†æ‰€æœ‰åº—å®¶çµ„
    storeGroups.forEach((group, index) => {
        const storeUrl = group.querySelector('.store-url-input').value.trim();
        const totalPriceInput = group.querySelector('.store-total-input');
        const totalPrice = roundToTwoDecimals(parseFloat(totalPriceInput?.value || 0));
        const quantityInput = group.querySelector('.store-quantity-input');
        const quantity = parseInt(quantityInput?.value || 0);
        const { productPrice, shippingCost, couponAmount } = calculateProductPrice(group);

        // å¦‚æœå•†å®¶é€£çµç‚ºç©ºï¼Œå®Œå…¨å¿½ç•¥ï¼ˆä¸æ–°å¢ï¼Œä¸æç¤ºï¼‰
        if (!storeUrl || storeUrl.length === 0) {
            return; // è¦–ç‚ºæœªæ–°å¢ï¼Œå¿½ç•¥æ­¤åº—å®¶çµ„
        }
        
        // å¦‚æœå•†å®¶é€£çµæœ‰å¡«å¯«ï¼Œä½†ç¸½é‡‘é¡æˆ–æ•¸é‡æœªå¡«ï¼Œè¨˜éŒ„éŒ¯èª¤ä¸¦é˜»æ­¢æäº¤
        const hasValidPrice = !isNaN(totalPrice) && totalPrice > 0;
        const hasValidQuantity = !isNaN(quantity) && quantity >= 1;
        
        if (!hasValidPrice || !hasValidQuantity) {
            // è¨˜éŒ„æœªå¡«å¯«çš„é …ç›®
            const missingFields = [];
            if (!hasValidPrice) missingFields.push('ç¸½é‡‘é¡');
            if (!hasValidQuantity) missingFields.push('æ•¸é‡');
            invalidGroups.push({
                index: index + 1,
                missingFields: missingFields.join('ã€')
            });
            return; // ä¸æ–°å¢æ­¤è¨˜éŒ„
        }

        // æ‰€æœ‰é …ç›®éƒ½å®Œæ•´ï¼ŒåŠ å…¥æ–°å¢åˆ—è¡¨
        const { productUnitPrice } = calculatePrice(totalPrice, quantity, shippingCost);
        const record = {
            id: Date.now() + Math.random(), // ç¢ºä¿å”¯ä¸€ID
            productName,
            productImageUrl: productImageUrl || null,
            storeUrl,
            productPrice,
            quantity,
            shippingCost,
            couponAmount,
            finalPrice: totalPrice,
            unitPrice: productUnitPrice
        };

        newRecords.push(record);
    });

    // å¦‚æœæœ‰å•†å®¶é€£çµä½†ç¸½é‡‘é¡æˆ–æ•¸é‡æœªå¡«ï¼Œé˜»æ­¢æäº¤ä¸¦æç¤º
    if (invalidGroups.length > 0) {
        const invalidDetails = invalidGroups.map(g => `ç¬¬ ${g.index} å€‹åº—å®¶ï¼ˆç¼ºå°‘ï¼š${g.missingFields}ï¼‰`).join('\n');
        alert(`ç„¡æ³•é€å‡ºæ¯”åƒ¹ï¼\n\nä»¥ä¸‹åº—å®¶å·²å¡«å¯«é€£çµï¼Œä½†è³‡æ–™ä¸å®Œæ•´ï¼š\n${invalidDetails}\n\nè«‹è£œé½Šæ‰€æœ‰å¿…å¡«é …ç›®å¾Œå†æäº¤ã€‚`);
        return; // é˜»æ­¢æäº¤
    }

    // å¦‚æœæ²’æœ‰å¯æ–°å¢çš„è¨˜éŒ„
    if (newRecords.length === 0) {
        alert('ç„¡æ–°æ•¸æ“šå¯æ–°å¢ã€‚è«‹è‡³å°‘å¡«å¯«ä¸€å€‹å®Œæ•´çš„åº—å®¶è³‡è¨Šï¼ˆç¸½é‡‘é¡ã€æ•¸é‡éœ€åœ¨å·²å¡«å¯«å•†å®¶é€£çµçš„æƒ…æ³ä¸‹å¡«å¯«ï¼‰ã€‚');
        return;
    }

    // æ–°å¢æ¨¡å¼ï¼Œæ·»åŠ æ‰€æœ‰è¨˜éŒ„
    newRecords.forEach(record => {
        priceData.push(record);
    });

    saveData();
    renderComparisonList();
    
    // é‡ç½®è¡¨å–®
    document.getElementById('priceForm').reset();
    document.getElementById('storesList').innerHTML = '';
    document.getElementById('storesContainer').classList.remove('active');
    storeGroupCounter = 0;
    resetImageUpload();
}

// ç·¨è¼¯è¨˜éŒ„ï¼ˆä½¿ç”¨å½ˆå‡ºè¦–çª—ï¼‰
let currentEditRecordId = null;
let currentViewProductName = null;
let currentViewImageUrl = null;

function editRecord(id) {
    const record = priceData.find(r => r.id === id);
    if (!record) return;

    currentEditRecordId = id;
    
    // æ‰“é–‹ç·¨è¼¯å½ˆå‡ºè¦–çª—
    const modal = document.getElementById('editRecordModal');
    const modalTitle = document.getElementById('editModalTitle');
    const urlInput = document.getElementById('editStoreUrl');
    const totalInput = document.getElementById('editTotalPrice');
    const quantityInput = document.getElementById('editQuantity');
    const shippingInput = document.getElementById('editShipping');
    const couponInput = document.getElementById('editCoupon');
    const urlValidation = document.getElementById('editUrlValidation');
    const detailsContainer = document.getElementById('editStoreDetails');
    
    modalTitle.textContent = `ç·¨è¼¯ã€${record.productName}ã€‘æ¯”åƒ¹è¨˜éŒ„`;
    modal.classList.add('active');
    
    // å¡«å……è¡¨å–®æ•¸æ“š
    urlInput.value = record.storeUrl || '';
    const finalPrice = record.finalPrice || (record.productPrice + (record.shippingCost || 0));
    totalInput.value = formatNumber(finalPrice);
    quantityInput.value = record.quantity || 1;
    shippingInput.value = record.shippingCost != null && record.shippingCost > 0 ? formatNumber(record.shippingCost) : '';
    couponInput.value = record.couponAmount != null && record.couponAmount > 0 ? formatNumber(record.couponAmount) : '';
    
    // é‡ç½®é©—è­‰è¨Šæ¯
    urlValidation.style.display = 'none';
    urlInput.style.borderColor = '';
    detailsContainer.classList.remove('hidden');
    
    // åˆå§‹åŒ–ç·¨è¼¯è¡¨å–®äº‹ä»¶ä¸¦è§¸ç™¼è¨ˆç®—
    initEditModalForm();
    calculateEditModalPrice();
}

function closeEditRecordModal() {
    document.getElementById('editRecordModal')?.classList.remove('active');
    currentEditRecordId = null;
}

// æŸ¥çœ‹å•†å“åœ–ç‰‡
function viewProductImage(imageUrl, productName) {
    const modal = document.getElementById('imageViewModal');
    const modalTitle = document.getElementById('imageViewModalTitle');
    const imageViewImage = document.getElementById('imageViewImage');
    const imageViewPlaceholder = document.getElementById('imageViewPlaceholder');
    const imageViewRemoveBtn = document.getElementById('imageViewRemoveBtn');
    
    if (!modal || !modalTitle || !imageViewImage) return;
    
    // ä¿å­˜ç•¶å‰æŸ¥çœ‹çš„å•†å“åç¨±å’Œåœ–ç‰‡URL
    currentViewProductName = productName;
    currentViewImageUrl = imageUrl;
    
    modalTitle.textContent = 'å•†å“åœ–ç‰‡';
    
    // æ ¹æ“šæ˜¯å¦æœ‰åœ–ç‰‡é¡¯ç¤ºä¸åŒç‹€æ…‹
    if (imageUrl) {
        imageViewImage.src = imageUrl;
        imageViewImage.alt = 'å•†å“åœ–ç‰‡';
        imageViewImage.classList.remove('hidden');
        if (imageViewPlaceholder) imageViewPlaceholder.classList.add('hidden');
        if (imageViewRemoveBtn) imageViewRemoveBtn.classList.remove('hidden');
    } else {
        imageViewImage.classList.add('hidden');
        if (imageViewPlaceholder) imageViewPlaceholder.classList.remove('hidden');
        if (imageViewRemoveBtn) imageViewRemoveBtn.classList.add('hidden');
    }
    
    modal.classList.add('active');
    
    // åˆå§‹åŒ–åœ–ç‰‡æŸ¥çœ‹å½ˆå‡ºè¦–çª—åŠŸèƒ½
    initImageViewReplace();
}

// æ–°å¢å•†å“åœ–ç‰‡ï¼ˆæ‰“é–‹åœ–ç‰‡æŸ¥çœ‹å½ˆå‡ºè¦–çª—ï¼Œé¡¯ç¤ºç‚ºä½”ä½ç¬¦ç‹€æ…‹ï¼‰
function addProductImage(productName) {
    viewProductImage(null, productName);
}

function closeImageViewModal() {
    document.getElementById('imageViewModal')?.classList.remove('active');
    currentViewProductName = null;
    currentViewImageUrl = null;
    // é‡ç½®æ–‡ä»¶è¼¸å…¥
    const fileInput = document.getElementById('imageViewFileInput');
    if (fileInput) fileInput.value = '';
}

// é¡¯ç¤ºåˆªé™¤åœ–ç‰‡ç¢ºèªå½ˆå‡ºè¦–çª—
function showDeleteImageConfirmModal() {
    const modal = document.getElementById('deleteImageConfirmModal');
    if (modal) {
        modal.classList.add('active');
    }
}

// é—œé–‰åˆªé™¤åœ–ç‰‡ç¢ºèªå½ˆå‡ºè¦–çª—
function closeDeleteImageConfirmModal() {
    const modal = document.getElementById('deleteImageConfirmModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// ç¢ºèªåˆªé™¤åœ–ç‰‡
async function confirmDeleteImage() {
    // åˆªé™¤è©²å•†å“æ‰€æœ‰è¨˜éŒ„çš„åœ–ç‰‡
    if (currentViewProductName && priceData) {
        priceData.forEach(record => {
            if (record.productName === currentViewProductName) {
                record.productImageUrl = null;
            }
        });
        
        // ä¿å­˜æ•¸æ“š
        await saveData();
        
        // æ›´æ–°é¡¯ç¤ºç‚ºä½”ä½ç¬¦ç‹€æ…‹
        const imageViewImage = document.getElementById('imageViewImage');
        const imageViewPlaceholder = document.getElementById('imageViewPlaceholder');
        const imageViewRemoveBtn = document.getElementById('imageViewRemoveBtn');
        
        if (imageViewImage) imageViewImage.classList.add('hidden');
        if (imageViewPlaceholder) imageViewPlaceholder.classList.remove('hidden');
        if (imageViewRemoveBtn) imageViewRemoveBtn.classList.add('hidden');
        currentViewImageUrl = null;
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        renderComparisonList();
        
        // é—œé–‰ç¢ºèªå½ˆå‡ºè¦–çª—
        closeDeleteImageConfirmModal();
    }
}

// åˆå§‹åŒ–åœ–ç‰‡æŸ¥çœ‹å½ˆå‡ºè¦–çª—çš„æ›¿æ›åŠŸèƒ½
function initImageViewReplace() {
    const fileInput = document.getElementById('imageViewFileInput');
    if (!fileInput) return;
    
    const imageViewImage = document.getElementById('imageViewImage');
    const imageViewPlaceholder = document.getElementById('imageViewPlaceholder');
    const imageViewRemoveBtn = document.getElementById('imageViewRemoveBtn');
    
    // è™•ç†æ–‡ä»¶é¸æ“‡
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        await handleImageViewFile(file);
    };
    
    // é»æ“Šåœ–ç‰‡æˆ–ä½”ä½ç¬¦é¸æ“‡æ–‡ä»¶
    if (imageViewImage) {
        imageViewImage.onclick = () => fileInput.click();
    }
    if (imageViewPlaceholder) {
        imageViewPlaceholder.onclick = () => fileInput.click();
    }
    
    // åˆªé™¤åœ–ç‰‡
    if (imageViewRemoveBtn) {
        imageViewRemoveBtn.onclick = (e) => {
            e.stopPropagation();
            showDeleteImageConfirmModal();
        };
    }
    
    // è¤‡è£½è²¼ä¸Šåœ–ç‰‡åŠŸèƒ½
    if (!window.imageViewPasteHandler) {
        window.imageViewPasteHandler = (e) => {
            const modal = document.getElementById('imageViewModal');
            if (!modal || !modal.classList.contains('active')) return;
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.isContentEditable) && activeElement.type !== 'file') return;
            const file = getImageFileFromClipboard(e);
            if (!file) return;
            e.preventDefault();
            handleImageViewFile(file);
        };
        
        document.addEventListener('paste', window.imageViewPasteHandler);
    }
}

// è™•ç†åœ–ç‰‡æŸ¥çœ‹å½ˆå‡ºè¦–çª—çš„æ–‡ä»¶
async function handleImageViewFile(file) {
    // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡æ–‡ä»¶
    if (!file.type.startsWith('image/')) {
        alert('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
        return;
    }
    
    try {
        // ä¸Šå‚³åœ–ç‰‡
        const newImageUrl = await uploadProductImageToView(file);
        
        // æ›´æ–°è©²å•†å“æ‰€æœ‰è¨˜éŒ„çš„åœ–ç‰‡URL
        if (currentViewProductName && priceData) {
            priceData.forEach(record => {
                if (record.productName === currentViewProductName) {
                    record.productImageUrl = newImageUrl;
                }
            });
            
            // ä¿å­˜æ•¸æ“š
            await saveData();
            
            // æ›´æ–°é¡¯ç¤º
            const imageViewImage = document.getElementById('imageViewImage');
            const imageViewPlaceholder = document.getElementById('imageViewPlaceholder');
            const imageViewRemoveBtn = document.getElementById('imageViewRemoveBtn');
            
            if (imageViewImage) {
                imageViewImage.src = newImageUrl;
                imageViewImage.classList.remove('hidden');
            }
            if (imageViewPlaceholder) imageViewPlaceholder.classList.add('hidden');
            if (imageViewRemoveBtn) imageViewRemoveBtn.classList.remove('hidden');
            currentViewImageUrl = newImageUrl;
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderComparisonList();
        }
    } catch (error) {
        alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}

async function uploadProductImageToView(file) {
    return uploadImageToStorage(file, {
        containerId: 'imageViewUploadProgress',
        fillId: 'imageViewProgressFill',
        textId: 'imageViewProgressText'
    });
}

function initEditModalForm() {
    // ç‚ºç·¨è¼¯å½ˆå‡ºè¦–çª—çš„è¼¸å…¥æ¡†è¨­ç½® Delete éµè¡Œç‚º
    const editForm = document.getElementById('editRecordModalForm');
    if (editForm) {
        setupInputDeleteBehavior(editForm);
    }
    
    const urlInput = document.getElementById('editStoreUrl');
    const totalInput = document.getElementById('editTotalPrice');
    const quantityInput = document.getElementById('editQuantity');
    const shippingInput = document.getElementById('editShipping');
    const couponInput = document.getElementById('editCoupon');
    const urlValidationMessage = document.getElementById('editUrlValidation');
    const detailsContainer = document.getElementById('editStoreDetails');
    
    // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆé€šéé‡æ–°ç¶å®šä¾†å¯¦ç¾ï¼‰
    const clonedInputs = cloneInputElements(['editStoreUrl', 'editTotalPrice', 'editQuantity', 'editShipping', 'editCoupon']);
    const newUrlInput = clonedInputs['editStoreUrl'];
    const newTotalInput = clonedInputs['editTotalPrice'];
    const newQuantityInput = clonedInputs['editQuantity'];
    const newShippingInput = clonedInputs['editShipping'];
    const newCouponInput = clonedInputs['editCoupon'];
    
    const validateEditUrl = () => {
        validateAndShowUrl(newUrlInput, urlValidationMessage, detailsContainer, currentEditRecordId);
    };
    
    newUrlInput.addEventListener('input', () => {
        setTimeout(validateEditUrl, 300);
    });
    
    newUrlInput.addEventListener('blur', validateEditUrl);
    
    bindNumberInputEvents([newTotalInput, newShippingInput, newCouponInput], calculateEditModalPrice);
    newQuantityInput.addEventListener('input', calculateEditModalPrice);
}

function calculateEditModalPrice() {
    const totalPrice = parseFloat(document.getElementById('editTotalPrice')?.value) || 0;
    const quantity = parseInt(document.getElementById('editQuantity')?.value) || 1;
    const shippingCost = roundToTwoDecimals(parseFloat(document.getElementById('editShipping')?.value) || 0);
    const { productPrice, productUnitPrice } = calculatePrice(totalPrice, quantity, shippingCost);
    
    const calculatedTotalEl = document.getElementById('editCalculatedTotal');
    const calculatedPriceEl = document.getElementById('editCalculatedPrice');
    updatePriceDisplay(calculatedTotalEl, calculatedPriceEl, productPrice, productUnitPrice, quantity);
}

// åˆªé™¤è¨˜éŒ„
function deleteRecord(id) {
    priceData = priceData.filter(r => r.id !== id);
    saveData();
    renderComparisonList();
}

// ç§»é™¤å•†å“çµ„ï¼ˆç§»é™¤è©²å•†å“åç¨±ä¸‹çš„æ‰€æœ‰è¨˜éŒ„ï¼‰
function removeProductGroup(productName) {
    if (!confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${productName}ã€çš„æ‰€æœ‰æ¯”åƒ¹è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;
    priceData = priceData.filter(r => r.productName !== productName);
    saveData();
    renderComparisonList();
}

const toggleStoreDetails = (id) => {
    const details = document.getElementById(`details-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);
    if (!details || !arrow) return;
    details.classList.toggle('expanded');
    arrow.classList.toggle('expanded');
};

// æ¸²æŸ“æ¯”åƒ¹åˆ—è¡¨
function renderComparisonList() {
    const comparisonList = document.getElementById('comparisonList');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const searchKeyword = searchInput ? searchInput.value.trim().toLowerCase() : '';

    if (priceData.length === 0) {
        comparisonList.classList.add('hidden');
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';
    comparisonList.classList.remove('hidden');

    // æŒ‰å•†å“åç¨±åˆ†çµ„ï¼ˆä¸ä¿®æ”¹åŸå§‹æ•¸æ“šï¼‰
    const groupedData = {};
    priceData.forEach(record => {
        const productName = record.productName || 'æœªåˆ†é¡å•†å“';
        if (!groupedData[productName]) {
            groupedData[productName] = [];
        }
        groupedData[productName].push(record);
    });

    // æ ¹æ“šæœå°‹é—œéµå­—éæ¿¾å•†å“
    let filteredProductNames = Object.keys(groupedData);
    if (searchKeyword) {
        filteredProductNames = filteredProductNames.filter(productName => {
            return productName.toLowerCase().includes(searchKeyword);
        });
    }

    // å¦‚æœæœå°‹å¾Œæ²’æœ‰çµæœï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
    if (filteredProductNames.length === 0) {
        comparisonList.classList.add('hidden');
        const safeSearchKeyword = searchKeyword.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        emptyState.innerHTML = `
            <p>ğŸ” æœªæ‰¾åˆ°ç¬¦åˆã€Œ${safeSearchKeyword}ã€çš„å•†å“</p>
            <p class="hint">è«‹å˜—è©¦å…¶ä»–é—œéµå­—</p>
        `;
        emptyState.style.display = 'block';
        return;
    }

    // ç”ŸæˆHTML
    comparisonList.innerHTML = filteredProductNames.map(productName => {
        // å‰µå»ºå‰¯æœ¬é€²è¡Œæ’åºï¼Œä¸ä¿®æ”¹åŸå§‹æ•¸æ“š
        const allRecords = [...groupedData[productName]];
        
        // è¨ˆç®—å–®åƒ¹æœ€å„ªæƒ 
        const recordsByUnitPrice = allRecords.map(record => {
            const unitPrice = record.unitPrice !== undefined ? record.unitPrice : (record.productPrice / (record.quantity || 1));
            return { ...record, calculatedUnitPrice: unitPrice };
        }).sort((a, b) => a.calculatedUnitPrice - b.calculatedUnitPrice);
        const minUnitPrice = recordsByUnitPrice[0]?.calculatedUnitPrice;
        const bestUnitPriceRecordIds = new Set();
        recordsByUnitPrice.forEach((record) => {
            if (record.calculatedUnitPrice === minUnitPrice) {
                bestUnitPriceRecordIds.add(record.id);
            }
        });
        
        // è¨ˆç®—ç¸½åƒ¹æœ€å„ªæƒ 
        const recordsByTotalPrice = [...allRecords].sort((a, b) => a.finalPrice - b.finalPrice);
        const minTotalPrice = recordsByTotalPrice[0]?.finalPrice;
        const bestTotalPriceRecordIds = new Set();
        recordsByTotalPrice.forEach((record) => {
            if (record.finalPrice === minTotalPrice) {
                bestTotalPriceRecordIds.add(record.id);
            }
        });
        
        // æŒ‰å–®åƒ¹æ’åºç”¨æ–¼é¡¯ç¤º
        const records = recordsByUnitPrice;
        
        // ç²å–å•†å“åœ–ç‰‡ï¼ˆå¾è©²å•†å“çš„æ‰€æœ‰è¨˜éŒ„ä¸­å°‹æ‰¾æœ‰åœ–ç‰‡çš„è¨˜éŒ„ï¼‰
        const recordWithImage = allRecords.find(r => r.productImageUrl);
        const productImageUrl = recordWithImage ? recordWithImage.productImageUrl : null;
        const hasImage = productImageUrl !== null;
        
        // è™•ç†ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ç ´å£ HTML å±¬æ€§
        // è½‰ç¾©é †åºï¼šåæ–œç·š -> å¼•è™Ÿ -> HTMLå¯¦é«”
        const escapeForJs = (str) => str.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
        const escapeForHtml = (str) => str.replace(/"/g, "&quot;");
        
        const safeImageUrl = hasImage ? escapeForHtml(escapeForJs(productImageUrl)) : '';
        const safeProductName = escapeForHtml(escapeForJs(productName));
        
        const imageClickHandler = hasImage ? `onclick="viewProductImage('${safeImageUrl}', '${safeProductName}')"` : `onclick="addProductImage('${safeProductName}')"`;
        const nameClass = hasImage ? 'product-group-name has-image' : 'product-group-name no-image';
        const titleAttr = hasImage ? `title="é»æ“ŠæŸ¥çœ‹åœ–ç‰‡"` : `title="é»æ“Šæ–°å¢åœ–ç‰‡"`;
        
        return `
            <div class="product-group">
                <div class="product-group-header">
                    <div class="product-name-wrapper">
                        <h3 class="${nameClass}" ${imageClickHandler} ${titleAttr}>${productName}</h3>
                        ${hasImage ? `
                        <div class="hover-thumbnail">
                            <img src="${safeImageUrl}" alt="${safeProductName}">
                        </div>
                        ` : ''}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-circle btn-add-store-to-product" onclick="openAddStoreModal('${safeProductName}')">+</button>
                        <button class="btn btn-circle btn-remove-product" onclick="removeProductGroup('${safeProductName}')">-</button>
                    </div>
                </div>
                <div class="product-stores-list">
                    ${records.map((record, index) => {
                        const recordId = record.id;
                        const couponAmount = record.couponAmount !== undefined ? record.couponAmount : 0;
                        const isBestUnitPrice = bestUnitPriceRecordIds.has(recordId);
                        const isBestTotalPrice = bestTotalPriceRecordIds.has(recordId);
                        const badges = [];
                        if (isBestUnitPrice) badges.push('<span class="best-unit-price-badge">å–®åƒ¹æœ€å„ªæƒ </span>');
                        if (isBestTotalPrice) badges.push('<span class="best-total-price-badge">ç¸½åƒ¹æœ€å„ªæƒ </span>');
                        // æª¢æ¸¬æ˜¯å¦ç‚º1688æˆ–æ·˜å¯¶ï¼Œä¸¦é¡¯ç¤ºå°æ‡‰åœ–ç¤º
                        const platformIcon = getStorePlatformIcon(record.storeUrl);
                        const storeDisplayName = platformIcon || `åº—å®¶${String.fromCharCode(65 + index)}`; // å¦‚æœæ˜¯1688æˆ–æ·˜å¯¶é¡¯ç¤ºå¹³å°åœ–ç¤ºï¼Œå¦å‰‡é¡¯ç¤ºåº—å®¶A/B/C
                        return `
                            <div class="store-item ${isBestUnitPrice || isBestTotalPrice ? 'best-price' : ''}">
                                <div class="store-item-header" onclick="toggleStoreDetails(${recordId})">
                                    <div class="store-item-name">
                                        <a href="${record.storeUrl}" target="_blank" class="store-link" onclick="event.stopPropagation();" title="${extractDomainFromUrl(record.storeUrl)}">${storeDisplayName}</a>
                                        ${badges.join('')}
                                    </div>
                                    <div class="store-item-price">
                                        ${formatPriceDisplay(record.finalPrice)}
                                    </div>
                                    <span class="store-item-arrow" id="arrow-${recordId}">â–¶</span>
                                </div>
                                <div class="store-item-details" id="details-${recordId}">
                                    <div class="detail-item">
                                        <span class="detail-label">å•†å“åƒ¹æ ¼</span>
                                        <span class="detail-value">${record.productPrice.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">æ•¸é‡</span>
                                        <span class="detail-value">${record.quantity || 1}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">é‹è²»</span>
                                        <span class="detail-value">
                                            ${record.shippingCost > 0 
                                                ? record.shippingCost.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                                : '<span class="text-success">å…é‹</span>'
                                            }
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">å„ªæƒ é‡‘é¡</span>
                                        <span class="detail-value">
                                            ${couponAmount > 0 
                                                ? `<span class="text-success">-${couponAmount.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>`
                                                : 'ç„¡'
                                            }
                                        </span>
                                    </div>
                                    ${record.quantity && record.quantity > 0 ? `
                                    <div class="detail-item">
                                        <span class="detail-label">å–®åƒ¹</span>
                                        <span class="detail-value text-primary">
                                            ${formatPriceDisplay(record.unitPrice !== undefined ? record.unitPrice : (record.productPrice / (record.quantity || 1)))}
                                        </span>
                                    </div>
                                    ` : ''}
                                    <div class="store-item-actions">
                                        <button class="btn btn-edit btn-small" onclick="event.stopPropagation(); editRecord(${recordId})">ç·¨è¼¯</button>
                                        <button class="btn btn-delete btn-small" onclick="event.stopPropagation(); deleteRecord(${recordId})">åˆªé™¤</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}

// æ–°å¢åº—å®¶å½ˆå‡ºè¦–çª—ç›¸é—œå‡½æ•¸
let currentModalProductName = '';

function openAddStoreModal(productName) {
    currentModalProductName = productName;
    const modal = document.getElementById('addStoreModal');
    const modalTitle = document.getElementById('modalProductName');
    const form = document.getElementById('addStoreModalForm');
    const detailsContainer = document.getElementById('modalStoreDetails');
    const urlValidation = document.getElementById('modalUrlValidation');
    const calculatedPrice = document.getElementById('modalCalculatedPrice');
    const calculatedTotal = document.getElementById('modalCalculatedTotal');
    
    modalTitle.textContent = `æ–°å¢ã€${productName}ã€‘æ¯”åƒ¹å•†å®¶`;
    modal.classList.add('active');
    
    // é‡ç½®è¡¨å–®
    form.reset();
    detailsContainer.classList.add('hidden');
    urlValidation.style.display = 'none';
    calculatedPrice.textContent = '-';
    calculatedTotal.textContent = '-';
    
    initModalForm();
}

function closeAddStoreModal() {
    document.getElementById('addStoreModal')?.classList.remove('active');
    currentModalProductName = '';
}

function initModalForm() {
    // ç‚ºå½ˆå‡ºè¦–çª—çš„è¼¸å…¥æ¡†è¨­ç½® Delete éµè¡Œç‚º
    const modalForm = document.getElementById('addStoreModalForm');
    if (modalForm) {
        setupInputDeleteBehavior(modalForm);
    }
    
    const urlInput = document.getElementById('modalStoreUrl');
    const totalInput = document.getElementById('modalTotalPrice');
    const quantityInput = document.getElementById('modalQuantity');
    const shippingInput = document.getElementById('modalShipping');
    const couponInput = document.getElementById('modalCoupon');
    const urlValidationMessage = document.getElementById('modalUrlValidation');
    const detailsContainer = document.getElementById('modalStoreDetails');
    const calculatedPriceEl = document.getElementById('modalCalculatedPrice');
    const calculatedTotalEl = document.getElementById('modalCalculatedTotal');
    
    // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆé€šéé‡æ–°ç¶å®šä¾†å¯¦ç¾ï¼‰
    const clonedInputs = cloneInputElements(['modalStoreUrl', 'modalTotalPrice', 'modalQuantity', 'modalShipping', 'modalCoupon']);
    const newUrlInput = clonedInputs['modalStoreUrl'];
    const newTotalInput = clonedInputs['modalTotalPrice'];
    const newQuantityInput = clonedInputs['modalQuantity'];
    const newShippingInput = clonedInputs['modalShipping'];
    const newCouponInput = clonedInputs['modalCoupon'];
    
    const calculateModalPrice = () => {
        const totalPrice = parseFloat(newTotalInput?.value) || 0;
        const quantity = parseInt(newQuantityInput?.value) || 1;
        const shippingCost = roundToTwoDecimals(parseFloat(newShippingInput?.value) || 0);
        const { productPrice, productUnitPrice } = calculatePrice(totalPrice, quantity, shippingCost);
        updatePriceDisplay(calculatedTotalEl, calculatedPriceEl, productPrice, productUnitPrice, quantity);
    };
    
    const validateModalUrl = () => {
        validateAndShowUrl(newUrlInput, urlValidationMessage, detailsContainer);
    };
    
    newUrlInput.addEventListener('input', () => {
        setTimeout(validateModalUrl, 300);
    });
    
    newUrlInput.addEventListener('blur', validateModalUrl);
    
    bindNumberInputEvents([newTotalInput, newShippingInput, newCouponInput], calculateModalPrice);
    newQuantityInput.addEventListener('input', calculateModalPrice);
}

// ç‚ºæ‰€æœ‰è¼¸å…¥æ¡†æ·»åŠ  Delete éµæ¸…ç©ºåŠŸèƒ½
function setupInputDeleteBehavior(element = document) {
    // é¸æ“‡æ‰€æœ‰è¼¸å…¥æ¡†ï¼ˆtext, number, url, textareaï¼‰
    const inputs = element.querySelectorAll ? element.querySelectorAll('input[type="text"], input[type="number"], input[type="url"], textarea') : [];
    
    inputs.forEach(input => {
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ éäº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡æ·»åŠ ï¼‰
        if (input.dataset.deleteHandlerAdded) return;
        input.dataset.deleteHandlerAdded = 'true';
        
        input.addEventListener('keydown', (e) => {
            // ç•¶æŒ‰ä¸‹ Delete éµæ™‚ï¼ˆä¸æ˜¯ Backspaceï¼‰
            if (e.key === 'Delete' || e.keyCode === 46) {
                // é˜»æ­¢é»˜èªè¡Œç‚º
                e.preventDefault();
                // æ¸…ç©ºè¼¸å…¥æ¡†
                input.value = '';
                // è§¸ç™¼ input äº‹ä»¶ä»¥è§¸ç™¼ç›¸é—œé©—è­‰æˆ–è¨ˆç®—
                input.dispatchEvent(new Event('input', { bubbles: true }));
                // è§¸ç™¼ change äº‹ä»¶
                input.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    });
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
    initForm();
    await loadData();
    
    // è¨­ç½®è¼¸å…¥æ¡† Delete éµè¡Œç‚º
    setupInputDeleteBehavior();
    
    // æœå°‹åŠŸèƒ½ï¼ˆå³æ™‚æœå°‹ï¼‰
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            // å³æ™‚æœå°‹ï¼Œæ¯æ¬¡è¼¸å…¥ç«‹å³è§¸ç™¼
            renderComparisonList();
        });
        
        // æ¸…é™¤æœå°‹æ¡†æ™‚ä¹Ÿé‡æ–°æ¸²æŸ“
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                searchInput.value = '';
                renderComparisonList();
                searchInput.blur();
            }
        });
    }
    
    // æäº¤æ–°å¢åº—å®¶è¡¨å–®
    const addStoreModalForm = document.getElementById('addStoreModalForm');
    if (addStoreModalForm) {
        addStoreModalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = getFormPriceData('modalStoreUrl', 'modalTotalPrice', 'modalQuantity', 'modalShipping', 'modalCoupon');
            const validation = validatePriceFormData(formData);
            
            if (!validation.valid) {
                alert(validation.message);
                return;
            }
            
            const newRecord = createPriceRecord(currentModalProductName, formData, null, findProductImageUrl(currentModalProductName));
            priceData.push(newRecord);
            saveData();
            renderComparisonList();
            closeAddStoreModal();
        });
    }
    
    setupModalOutsideClick('addStoreModal', closeAddStoreModal);
    
    // æäº¤ç·¨è¼¯è¨˜éŒ„è¡¨å–®
    const editRecordModalForm = document.getElementById('editRecordModalForm');
    if (editRecordModalForm) {
        editRecordModalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentEditRecordId) return;
            
            const recordIndex = priceData.findIndex(r => r.id === currentEditRecordId);
            if (recordIndex === -1) return;
            
            const productName = priceData[recordIndex].productName;
            const originalRecord = priceData[recordIndex];
            const formData = getFormPriceData('editStoreUrl', 'editTotalPrice', 'editQuantity', 'editShipping', 'editCoupon');
            const validation = validatePriceFormData(formData);
            
            if (!validation.valid) {
                alert(validation.message);
                return;
            }
            
            priceData[recordIndex] = createPriceRecord(productName, formData, currentEditRecordId, findProductImageUrl(productName, originalRecord));
            saveData();
            renderComparisonList();
            closeEditRecordModal();
        });
    }
    
    setupModalOutsideClick('editRecordModal', closeEditRecordModal);
    setupModalOutsideClick('imageViewModal', closeImageViewModal);
    setupModalOutsideClick('deleteImageConfirmModal', closeDeleteImageConfirmModal);
    
    // ç¶å®šç¢ºèªåˆªé™¤æŒ‰éˆ•
    const confirmDeleteImageBtn = document.getElementById('confirmDeleteImageBtn');
    if (confirmDeleteImageBtn) {
        confirmDeleteImageBtn.addEventListener('click', confirmDeleteImage);
    }
});
    </script>
</body>
</html>

