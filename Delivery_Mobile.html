<div class="cyber-panel">
    <h1 class="page-title">üì¶ Â§ñÈÄÅË≥áÁî¢Ë®ÇË≥ºÂñÆ</h1>
    <div id="date-picker">
        <label class="date-label">ÈÅ∏ÊìáÊó•ÊúüÔºö</label>
        <span id="date-display"></span>
        <button id="reset-date-button"><span>‰ªäÂ§©</span></button>
        <div id="date-modal">
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="prev-month">‚Äπ</button>
                <div class="calendar-month-year">
                    <select id="year-select"></select>
                    <select id="month-select"></select>
                </div>
                <button class="calendar-nav-btn" id="next-month">‚Ä∫</button>
            </div>
            <div class="calendar-weekdays">
                <div>Êó•</div>
                <div>‰∏Ä</div>
                <div>‰∫å</div>
                <div>‰∏â</div>
                <div>Âõõ</div>
                <div>‰∫î</div>
                <div>ÂÖ≠</div>
            </div>
            <div class="calendar-days" id="calendar-days"></div>
        </div>
    </div>
    <div id="categories-container"></div>
    <div class="category-section">
        <div class="category-title">Êé°Ë≥ºË®àÁÆó</div>
        <div id="hud-display"></div>
    </div>
    <div class="category-section">
        <div class="category-title">Êé°Ë≥ºÊàêÊú¨</div>
        <div id="cost-display" class="no-copy"></div>
        <div id="cost-summary" class="cost-summary no-copy">
            <div class="cost-total-row">
                <span class="cost-total">Á∏ΩÊàêÊú¨: <span id="total-cost-amount">0</span> ÂÖÉ</span>
                <input type="text" id="cost-note-input" class="cost-note-input">
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --space-blue: #1a1a2e;
        --neon-cyan: #00f3ff;
        --cyber-purple: #712f79;
        --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --bg-dark: rgba(0,0,0,0.3);
        --bg-darker: rgba(0,0,0,0.5);
        --bg-gradient: linear-gradient(135deg, rgba(0,243,255,0.1) 0%, rgba(113,47,121,0.1) 100%);
        --shadow-cyan: rgba(0,243,255,0.3);
        --shadow-purple: rgba(113,47,121,0.4);
        --grid-line: rgba(0,243,255,0.1) 1px;
        --select-bg: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(26,26,46,0.6) 100%);
        --day-bg: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(26,26,46,0.5) 100%);
    }
    body {
        background: var(--space-blue);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }
    body::before {
        content: '';
        position: fixed;
        inset: 0;
        background: linear-gradient(45deg, var(--grid-line), transparent 1px), linear-gradient(-45deg, var(--grid-line), transparent 1px);
        background-size: 40px 40px;
        z-index: -1;
        animation: gridMove 20s linear infinite;
    }
    body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at center, transparent 0%, var(--space-blue) 100%);
        z-index: -1;
    }
    @keyframes gridMove { to { background-position: 40px 40px; } }
    .cyber-panel {
        background: var(--space-blue);
        color: var(--neon-cyan);
        border: 1px solid var(--neon-cyan);
        border-radius: 8px;
        padding: 0.5rem;
        width: 100%;
        max-width: 360px;
        box-shadow: 0 0 15px rgba(0,243,255,0.2);
        box-sizing: border-box;
        margin: 0 auto;
    }
    .page-title { text-align: center; margin-bottom: 0.8rem; }
    .date-label { color: var(--neon-cyan); margin-right: 5px; font-weight: 500; }
    .category-section { margin-bottom: 0.8rem; }
    .category-title {
        color: var(--neon-cyan);
        font-size: 1.2rem;
        margin-bottom: 0.4rem;
        border-bottom: 1px solid var(--cyber-purple);
        padding-bottom: 0.2rem;
    }
    .grid-container { display: grid; grid-template-columns: 1fr; gap: 0.5rem; padding: 0.5rem 0; }
    .cyber-input {
        background: var(--bg-dark);
        border: 1px solid var(--cyber-purple);
        border-radius: 6px;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all var(--transition);
    }
    .cyber-input:hover { transform: translateY(-2px); box-shadow: 0 3px 10px var(--shadow-purple); }
    .cyber-input .label { text-align: left; }
    input[type="text"], .cost-note-input {
        width: 80px;
        padding: 0.5rem;
        background: transparent;
        border: 1px solid var(--neon-cyan);
        border-radius: 4px;
        color: var(--neon-cyan);
        font-size: 1rem;
        text-align: center;
        transition: border-color var(--transition);
    }
    .cost-note-input { padding: 0.4rem; background: var(--bg-dark); font-size: 0.9rem; }
    input[type="text"]:focus, .cost-note-input:focus { border-color: var(--cyber-purple); outline: none; }
    #hud-display, #cost-display, .cost-summary {
        background: var(--bg-darker);
        border: 1px solid var(--neon-cyan);
        border-radius: 6px;
        padding: 0.8rem;
        margin-top: 0.8rem;
        backdrop-filter: blur(8px);
        transition: border-color var(--transition);
        text-align: left;
    }
    #hud-display { cursor: pointer; }
    #hud-display:hover { border-color: var(--cyber-purple); }
    #hud-display p, #cost-display p { margin: 3px 0; font-size: 1rem; color: var(--neon-cyan); }
    .cost-summary { display: none; }
    .cost-total-row { display: flex; justify-content: space-between; align-items: center; }
    .cost-total { font-weight: bold; color: var(--neon-cyan); font-size: 1.1rem; }
    #date-picker {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        text-align: center;
        margin-bottom: 0.4rem;
    }
    #date-display {
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 140px;
        padding: 0.5rem 1rem;
        background: var(--bg-gradient);
        border: 2px solid var(--neon-cyan);
        border-radius: 8px;
        color: var(--neon-cyan);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px var(--shadow-cyan);
        transition: all var(--transition);
    }
    #date-display::before {
        content: '';
        position: absolute;
        inset: 0;
        left: -100%;
        background: linear-gradient(90deg, transparent, rgba(0,243,255,0.2), transparent);
        transition: left 0.5s;
    }
    #date-display:hover::before { left: 100%; }
    #date-display:hover {
        transform: translateY(-2px);
        border-color: var(--cyber-purple);
        box-shadow: 0 4px 16px var(--shadow-cyan);
        background: linear-gradient(135deg, rgba(0,243,255,0.15) 0%, rgba(113,47,121,0.15) 100%);
    }
    #date-display:active { transform: translateY(0); }
    #date-modal {
        display: none;
        position: absolute;
        top: calc(100% + 10px);
        left: 50%;
        transform: translateX(-50%);
        min-width: 300px;
        padding: 1rem;
        background: linear-gradient(135deg, rgba(26,26,46,0.95) 0%, rgba(0,0,0,0.95) 100%);
        border: 2px solid var(--neon-cyan);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,243,255,0.3), 0 0 0 1px rgba(0,243,255,0.1);
        backdrop-filter: blur(10px);
        z-index: 10;
        animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    #date-modal::before {
        content: '';
        position: absolute;
        inset: -2px;
        background: linear-gradient(45deg, var(--neon-cyan), var(--cyber-purple), var(--neon-cyan));
        border-radius: 12px;
        z-index: -1;
        opacity: 0.3;
        animation: borderGlow 3s ease-in-out infinite;
    }
    @keyframes borderGlow { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }
    .calendar-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 1rem; }
    .calendar-nav-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: 2px solid var(--cyber-purple);
        border-radius: 8px;
        background: var(--select-bg);
        color: var(--neon-cyan);
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transition: all var(--transition);
    }
    .calendar-nav-btn:hover {
        border-color: var(--neon-cyan);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow-cyan);
        background: linear-gradient(135deg, rgba(0,243,255,0.1) 0%, rgba(26,26,46,0.8) 100%);
    }
    .calendar-nav-btn:active, #reset-date-button:active { transform: translateY(0); }
    .calendar-month-year { display: flex; gap: 0.5rem; flex: 1; justify-content: center; }
    #date-modal select {
        flex: 1;
        padding: 0.5rem 2.5rem 0.5rem 1rem;
        border: 2px solid var(--cyber-purple);
        border-radius: 8px;
        background: var(--select-bg);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300f3ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.8rem center;
        background-size: 12px;
        color: var(--neon-cyan);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transition: all var(--transition);
        appearance: none;
    }
    #date-modal select:hover {
        border-color: var(--neon-cyan);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow-cyan);
        background: linear-gradient(135deg, rgba(0,243,255,0.1) 0%, rgba(26,26,46,0.8) 100%);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300f3ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.8rem center;
    }
    #date-modal select:focus {
        outline: none;
        border-color: var(--neon-cyan);
        box-shadow: 0 0 0 3px rgba(0,243,255,0.2), 0 4px 12px var(--shadow-cyan);
    }
    #date-modal select option { background: var(--space-blue); color: var(--neon-cyan); padding: 0.5rem; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.3rem; margin-bottom: 0.5rem; }
    .calendar-weekdays div { text-align: center; font-weight: 600; color: var(--neon-cyan); font-size: 0.9rem; padding: 0.4rem 0; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.3rem; }
    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
        border-radius: 8px;
        background: var(--day-bg);
        color: var(--neon-cyan);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .calendar-day::before {
        content: '';
        position: absolute;
        inset: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(0,243,255,0.2);
        transform: translate(-50%, -50%);
        transition: width 0.3s, height 0.3s;
    }
    .calendar-day:hover::before { inset: 0; width: 100%; height: 100%; }
    .calendar-day:hover { border-color: var(--neon-cyan); box-shadow: 0 2px 8px rgba(0,243,255,0.3); transform: scale(1.05); z-index: 1; }
    .calendar-day.other-month { color: rgba(0,243,255,0.3); background: rgba(0,0,0,0.1); }
    .calendar-day.today {
        border-color: var(--cyber-purple);
        font-weight: 700;
        background: linear-gradient(135deg, rgba(113,47,121,0.2) 0%, rgba(0,243,255,0.1) 100%);
        box-shadow: 0 0 8px rgba(113,47,121,0.4);
    }
    .calendar-day.selected {
        border-color: var(--neon-cyan);
        font-weight: 700;
        transform: scale(1.1);
        z-index: 2;
        background: linear-gradient(135deg, rgba(0,243,255,0.3) 0%, rgba(113,47,121,0.2) 100%);
        box-shadow: 0 0 12px rgba(0,243,255,0.5);
    }
    .calendar-day.selected::before { inset: 0; width: 100%; height: 100%; background: rgba(0,243,255,0.1); }
    #reset-date-button {
        position: relative;
        overflow: hidden;
        padding: 0.5rem 1rem;
        border: 2px solid var(--neon-cyan);
        border-radius: 8px;
        background: linear-gradient(135deg, var(--cyber-purple) 0%, rgba(113,47,121,0.8) 100%);
        color: var(--neon-cyan);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px var(--shadow-purple);
        transition: all var(--transition);
    }
    #reset-date-button::before {
        content: '';
        position: absolute;
        inset: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(0,243,255,0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }
    #reset-date-button:hover::before { width: 300px; height: 300px; }
    #reset-date-button:hover {
        transform: translateY(-2px);
        border-color: var(--cyber-purple);
        color: var(--space-blue);
        background: linear-gradient(135deg, var(--neon-cyan) 0%, rgba(0,243,255,0.9) 100%);
        box-shadow: 0 4px 16px var(--shadow-cyan);
    }
    #reset-date-button span { position: relative; z-index: 1; }
    @media (max-width: 480px) {
        .cyber-panel { padding: 0.4rem; max-width: 100%; }
        .category-title { font-size: 1.1rem; }
        .cyber-input { padding: 0.4rem; }
        input[type="text"], .cost-note-input { width: 70px; font-size: 0.9rem; }
        #hud-display, #cost-display { padding: 0.6rem; }
        #date-picker { flex-direction: column; gap: 0.6rem; }
        #date-display { width: 100%; min-width: auto; }
        #reset-date-button { width: 100%; }
        #date-modal { min-width: 90%; left: 50%; transform: translateX(-50%); padding: 0.8rem; }
        .calendar-header { margin-bottom: 0.8rem; }
        .calendar-nav-btn { width: 32px; height: 32px; font-size: 1.2rem; }
        #date-modal select { padding: 0.4rem 2rem 0.4rem 0.8rem; font-size: 0.9rem; }
        .calendar-day { font-size: 0.85rem; }
        .calendar-weekdays div { font-size: 0.8rem; }
    }
</style>

<script>
    const utils = {
        padZero: n => String(n).padStart(2, '0'),
        getDaysInMonth: (y, m) => new Date(y, m, 0).getDate(),
        formatNumber: n => n.toLocaleString(),
        setCursorEnd: el => setTimeout(() => el.setSelectionRange(el.value.length, el.value.length), 0)
    };

    const inputConfig = [
        { category: 'UberEats', items: [
            { label: 'UberEatsÊèêË¢ã', name: 'ubereats_bag' },
            { label: 'UberEatsÂÖ≠Ê†ºÁÆ±', name: 'ubereats_6grid' },
            { label: 'UberEatsÂÖ´Ê†ºÁÆ±', name: 'ubereats_8grid' }
        ]},
        { category: 'FoodPanda', items: [
            { label: 'FoodPandaÊèêË¢ã', name: 'foodpanda_bag' },
            { label: 'FoodPandaÂÖ≠Ê†ºÁÆ±', name: 'foodpanda_6grid' },
            { label: 'FoodPandaÂÖ´Ê†ºÁÆ±', name: 'foodpanda_8grid' },
            { label: 'FoodPanda 2022ÂÖ≠Ê†ºÁÆ±', name: 'foodpanda_2022_6grid' },
            { label: 'FoodPanda 2022ÂÖ´Ê†ºÁÆ±', name: 'foodpanda_2022_8grid' },
            { label: 'FoodPandaÈ≠îÈ¨ºÊ∞à‰øùÊ∫´ÁÆ±', name: 'foodpanda_velcro_insulated' },
            { label: 'FoodPandaÁ£ÅÂê∏Âºè‰øùÊ∫´ÁÆ±', name: 'foodpanda_magnetic_insulated' },
            { label: 'FoodPanda‰∏äÊéÄÊ¨æ‰øùÊ∫´ÁÆ±', name: 'foodpanda_flip_insulated' }
        ]}
    ];

    const productConfig = {
        limits: { ubereats_bag: 50, ubereats_6grid: 15, ubereats_8grid: 13, foodpanda_bag: 80, foodpanda_6grid: 15, foodpanda_8grid: 13, foodpanda_2022_6grid: 15, foodpanda_2022_8grid: 13, foodpanda_velcro_insulated: 10, foodpanda_magnetic_insulated: 10, foodpanda_flip_insulated: 6 },
        unitPrices: { ubereats_bag: 10, foodpanda_bag: 13, ubereats_6grid: 65, ubereats_8grid: 70, foodpanda_6grid: 65, foodpanda_8grid: 70, foodpanda_2022_6grid: 65, foodpanda_2022_8grid: 70, foodpanda_velcro_insulated: 135, foodpanda_magnetic_insulated: 135, foodpanda_flip_insulated: 170 }
    };

    const dateManager = {
        state: { year: 2025, month: new Date().getMonth() + 1, day: new Date().getDate() },
        el: null,
        get elements() {
            if (!this.el) this.el = {
                display: document.getElementById('date-display'),
                modal: document.getElementById('date-modal'),
                yearSelect: document.getElementById('year-select'),
                monthSelect: document.getElementById('month-select'),
                calendarDays: document.getElementById('calendar-days'),
                prevMonthBtn: document.getElementById('prev-month'),
                nextMonthBtn: document.getElementById('next-month')
            };
            return this.el;
        },
        init() { this.render(); this.bindEvents(); },
        render() {
            const s = this.state;
            this.elements.display.textContent = `${s.year}/${utils.padZero(s.month)}/${utils.padZero(s.day)}`;
            this.populateSelect(this.elements.yearSelect, 2025, 2054, s.year, false);
            this.populateSelect(this.elements.monthSelect, 1, 12, s.month, true);
            this.renderCalendar();
            calculateResult();
        },
        populateSelect(select, start, end, selected, pad) {
            select.innerHTML = '';
            for (let i = start; i <= end; i++)
                select.add(new Option(pad ? utils.padZero(i) : i, i, i === selected));
        },
        adjacentMonth(offset) {
            let m = this.state.month + offset, y = this.state.year;
            if (m < 1) { m = 12; y--; } else if (m > 12) { m = 1; y++; }
            return { year: y, month: m };
        },
        renderCalendar() {
            const today = new Date();
            const { year, month, day } = this.state;
            const daysInMonth = utils.getDaysInMonth(year, month);
            const startDay = new Date(year, month - 1, 1).getDay();
            const cd = this.elements.calendarDays;
            cd.innerHTML = '';
            const prev = this.adjacentMonth(-1);
            const prevLast = utils.getDaysInMonth(prev.year, prev.month);
            for (let i = startDay - 1; i >= 0; i--)
                cd.appendChild(this.createDay(prevLast - i, true, prev.year, prev.month));
            const tY = today.getFullYear(), tM = today.getMonth() + 1, tD = today.getDate();
            for (let d = 1; d <= daysInMonth; d++)
                cd.appendChild(this.createDay(d, false, year, month, tY === year && tM === month && tD === d, day === d));
            const next = this.adjacentMonth(1);
            for (let d = 1, n = 42 - cd.children.length; d <= n; d++)
                cd.appendChild(this.createDay(d, true, next.year, next.month));
        },
        createDay(day, other, y, m, isToday = false, selected = false) {
            const el = document.createElement('div');
            el.className = ['calendar-day', other && 'other-month', isToday && 'today', selected && 'selected'].filter(Boolean).join(' ');
            el.textContent = day;
            el.onclick = () => {
                Object.assign(this.state, { year: y, month: m, day });
                this.elements.modal.style.display = 'none';
                this.render();
            };
            return el;
        },
        resetToToday() {
            const t = new Date();
            this.state.year = Math.max(2025, t.getFullYear());
            this.state.month = t.getMonth() + 1;
            this.state.day = t.getDate();
            this.render();
        },
        adjustDay() {
            const max = utils.getDaysInMonth(this.state.year, this.state.month);
            if (this.state.day > max) this.state.day = max;
        },
        changeMonth(delta) {
            let { year, month } = this.state;
            month += delta;
            if (month > 12) { month = 1; year++; } else if (month < 1) { month = 12; year--; }
            Object.assign(this.state, { year, month });
            this.adjustDay();
            this.render();
        },
        bindEvents() {
            const { display, modal } = this.elements;
            display.onclick = () => { modal.style.display = modal.style.display === 'block' ? 'none' : 'block'; };
            document.getElementById('reset-date-button').onclick = () => this.resetToToday();
            this.elements.prevMonthBtn.onclick = () => this.changeMonth(-1);
            this.elements.nextMonthBtn.onclick = () => this.changeMonth(1);
            [this.elements.yearSelect, this.elements.monthSelect].forEach((select, i) => {
                select.onchange = e => {
                    const v = +e.target.value;
                    this.state[i ? 'month' : 'year'] = v;
                    this.adjustDay();
                    this.render();
                };
            });
            document.addEventListener('click', e => {
                if (!modal.contains(e.target) && !display.contains(e.target) && !document.getElementById('reset-date-button').contains(e.target))
                    modal.style.display = 'none';
            }, true);
        }
    };

    const expressionParser = {
        evaluate(expr) {
            if (!expr || (expr = String(expr).trim()) === '' || expr === '0') return expr === '0' ? '0' : '';
            try {
                const tokens = (expr.match(/(\d+|\+|-|\*|\/)/g) || []).map(t => /\d+/.test(t) ? +t : t);
                if (!tokens.length) return '';
                const ops = { '+': (a, b) => a + b, '-': (a, b) => a - b, '*': (a, b) => a * b, '/': (a, b) => Math.floor(a / b) };
                let stack = [], num = 0, op = '+';
                for (const t of tokens) {
                    if (typeof t === 'number') {
                        num = t;
                        if (op === '+') stack.push(num);
                        else if (op === '-') stack.push(-num);
                        else stack.push(ops[op](stack.pop(), num));
                    } else op = t;
                }
                const result = Math.max(0, Math.round(stack.reduce((a, b) => a + b, 0)));
                return result === 0 && expr !== '0' ? '' : String(result);
            } catch { return ''; }
        }
    };

    const inputManager = {
        inputs: [],
        previousValues: {},
        hasLostFocus: {},
        currentInput: null,
        windowBlurred: false,
        commitInput(input) {
            if (!input) return;
            const raw = String(input.value);
            let val = expressionParser.evaluate(raw);
            if (raw !== val) input.value = val;
            const prev = this.previousValues[input.name] || 0;
            if (prev > 0 && (val === '0' || val !== '')) {
                const sum = (+val || 0) + prev;
                input.value = sum === 0 && raw !== '0' ? '' : String(sum);
                this.previousValues[input.name] = 0;
            }
            calculateResult();
        },
        setupInput(input, index) {
            if (input.id === 'cost-note-input') return;
            this.previousValues[input.name] = 0;
            this.hasLostFocus[input.name] = false;
            input.onfocus = () => {
                this.currentInput = input;
                if (this.windowBlurred) { this.windowBlurred = false; return; }
                if (this.hasLostFocus[input.name] && input.value) {
                    this.previousValues[input.name] = +input.value || 0;
                    input.value = '';
                    this.hasLostFocus[input.name] = false;
                }
            };
            input.onblur = () => {
                this.commitInput(input);
                this.hasLostFocus[input.name] = true;
                this.currentInput = null;
            };
            input.onclick = () => {
                if (input.value) {
                    const v = expressionParser.evaluate(input.value);
                    if (input.value !== v) { input.value = v; calculateResult(); }
                }
                utils.setCursorEnd(input);
            };
            input.onkeydown = e => {
                if (e.key === 'Delete') {
                    input.value = '';
                    this.previousValues[input.name] = 0;
                    this.hasLostFocus[input.name] = false;
                    calculateResult();
                } else if (e.key === 'Enter') {
                    this.commitInput(input);
                    const next = this.inputs[(index + 1) % this.inputs.length];
                    next.focus();
                    utils.setCursorEnd(next);
                }
            };
        },
        setupExchangeRateInput() {
            const el = document.getElementById('cost-note-input');
            if (!el) return;
            const update = () => resultManager.updateExchangeRate();
            ['input', 'blur'].forEach(ev => el.addEventListener(ev, update));
            el.onkeydown = e => { if (e.key === 'Delete') el.value = ''; if (e.key === 'Delete' || e.key === 'Enter') update(); };
            el.onclick = e => { e.stopPropagation(); utils.setCursorEnd(el); };
        },
        init() {
            this.inputs = Array.from(document.querySelectorAll('input[type="text"]'));
            this.inputs.forEach((input, i) => this.setupInput(input, i));
            window.onblur = () => {
                this.windowBlurred = true;
                if (this.currentInput && !this.currentInput.id.includes('cost-note')) this.commitInput(this.currentInput);
            };
            window.onfocus = () => { this.windowBlurred = false; };
            this.setupExchangeRateInput();
        }
    };

    const resultManager = {
        hudDisplay: document.getElementById('hud-display'),
        costDisplay: document.getElementById('cost-display'),
        costSummary: document.getElementById('cost-summary'),
        currentTotalCost: 0,
        update() {
            const { year, month, day } = dateManager.state;
            const dateStr = `${year}/${utils.padZero(month)}/${utils.padZero(day)}Ë®ÇÂñÆ`;
            const items = inputManager.inputs
                .filter(inp => inp.id !== 'cost-note-input' && inp.value)
                .map(inp => {
                    const v = +inp.value || 0;
                    if (v <= 0) return null;
                    const name = inp.name;
                    const limit = productConfig.limits[name];
                    const boxes = Math.ceil(v / limit);
                    return {
                        label: inp.parentElement.querySelector('.label').textContent.trim(),
                        count: v,
                        boxes,
                        limit,
                        excess: boxes * limit - v,
                        cost: v * (productConfig.unitPrices[name] || 0)
                    };
                })
                .filter(Boolean);
            this.currentTotalCost = items.reduce((s, i) => s + i.cost, 0);
            this.hudDisplay.innerHTML = `<p>${dateStr}</p>` + items.map(i =>
                `<p>${i.label} √ó${i.boxes}${i.excess > 0 ? ` „ÄêÈ§ò${i.excess}‰ª∂„Äë` : ''}</p>`).join('');
            const costItems = items.filter(i => i.cost > 0);
            this.costDisplay.innerHTML = `<p>${dateStr}</p>` + (costItems.length
                ? costItems.map(i => `<p>${i.label} * ${i.count} = ${utils.formatNumber(i.cost)} ÂÖÉ</p>`).join('')
                : '<p>Â∞öÁÑ°ÊàêÊú¨Ë≥áÊñô</p>');
            this.costSummary.style.display = costItems.length ? 'block' : 'none';
            if (costItems.length) this.updateExchangeRate();
        },
        updateExchangeRate() {
            const inp = document.getElementById('cost-note-input');
            const totalEl = document.getElementById('total-cost-amount');
            if (!inp || !totalEl) return;
            const rate = +inp.value;
            totalEl.textContent = utils.formatNumber((rate && !isNaN(rate) && this.currentTotalCost > 0)
                ? this.currentTotalCost * rate : this.currentTotalCost);
        },
        async copyBoxes() {
            const text = Array.from(this.hudDisplay.querySelectorAll('p')).map(p => p.textContent).join('\n');
            try { await navigator.clipboard.writeText(text); alert('Ë§áË£ΩÊàêÂäü'); } catch { alert('Ë§áË£ΩÂ§±Êïó'); }
        },
        init() {
            this.hudDisplay.onclick = () => this.copyBoxes();
            this.update();
        }
    };

    function initHTML() {
        document.getElementById('categories-container').innerHTML = inputConfig.map(c => `
            <div class="category-section">
                <div class="category-title">${c.category}</div>
                <div class="grid-container" data-category="${c.category.toLowerCase()}">
                    ${c.items.map(i => `<div class="cyber-input"><span class="label">${i.label}</span><input type="text" name="${i.name}" value=""></div>`).join('')}
                </div>
            </div>`).join('');
    }

    const calculateResult = () => resultManager.update();

    initHTML();
    dateManager.init();
    inputManager.init();
    resultManager.init();
</script>
